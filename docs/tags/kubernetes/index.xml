<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>kubernetes on bailiyingqi&#39;s blog</title>
    <link>https://zhangsiming-blyq.github.io/tags/kubernetes/</link>
    <description>Recent content in kubernetes on bailiyingqi&#39;s blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <copyright>Copyright Â© 2008â€“2018, Steve Francia and the Hugo Authors; all rights reserved.</copyright>
    <lastBuildDate>Mon, 12 Sep 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://zhangsiming-blyq.github.io/tags/kubernetes/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>è°ˆè°ˆkubernetes è¯ä¹¦è®¤è¯é‚£äº›äº‹å„¿</title>
      <link>https://zhangsiming-blyq.github.io/post/kubernetes-certificate/</link>
      <pubDate>Mon, 12 Sep 2022 00:00:00 +0000</pubDate>
      
      <guid>https://zhangsiming-blyq.github.io/post/kubernetes-certificate/</guid>
      <description>
        
          
            kuberneteså„ä¸ªç»„ä»¶éƒ½æ˜¯åŠ å¯†é€šä¿¡çš„, é‚£ä¹ˆéƒ½æœ‰å“ªäº›è¯ä¹¦ã€å„ä¸ªè¯ä¹¦æ€ä¹ˆäº¤äº’ã€è¿™äº›è¯ä¹¦ä»€ä¹ˆæ—¶å€™è¿‡æœŸï¼Œè¿™ä¸ªå°±å˜å¾—è‡³å…³é‡è¦; æœ¬æ–‡å¼•ç”¨äº†ä¸€äº›å…¶ä»–ç½‘ç»œå†…å®¹(å‡å·²é™„ä¸ŠåŸæ–‡é“¾æ¥)ï¼Œå¹¶é€‚å½“è¡¥å……å®Œå–„ï¼Œç”¨äºè®©æ–°æ‰‹å®Œå–„ç†Ÿæ‚‰kubernetesè¯ä¹¦ä½“ç³»(å¦‚æœ‰ä¾µæƒè”ç³»é‚®ç®±å¯ä»¥åˆ é™¤)ã€‚
ä¸€ã€æ•°å­—è¯ä¹¦åŸç† 1.1 ä¼ ç»Ÿéå¯¹ç§°åŠ å¯† 1message --&amp;gt; (å…¬é’¥åŠ å¯†) --&amp;gt; || ä¼ è¾“ || --&amp;gt; (ç§é’¥è§£å¯†) --&amp;gt; message æ³¨æ„:
1.è¿™é‡Œä¸æ•°å­—è¯ä¹¦è®¤è¯ç›¸åï¼Œæ˜¯å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†
2.å…¬é’¥ç§é’¥éœ€è¦æ˜¯ä¸€ä¸ªç§˜é’¥å¯¹
1.2 å“ˆå¸Œå‡½æ•° 1message --&amp;gt; H(message) --&amp;gt; Hash message å¤„ç†åŠ å…¥ä¸€ä¸ªéšæœºæ•°ï¼Œç„¶åå¾—å‡ºç»“æœ(åŠ ç›); å¯ä»¥æœ‰æ•ˆç¼“è§£åœ¨è¾“å…¥å€¼æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é›†åˆï¼Œå“ˆå¸Œå€¼ä¹Ÿæ˜¯å›ºå®šé•¿åº¦è¢«åˆ«äººâ€˜è¯•â€™å‡ºæ¥çš„å‡ ç‡
1message --&amp;gt; H(R|message) --&amp;gt; Hash message 1.3 æ•°å­—è¯ä¹¦ 1.3.1 æ•°å­—ç­¾å æ•°å­—ç­¾åï¼›æŠŠæ•°æ®æ ¹æ®ç§é’¥/å“ˆå¸Œè¿›è¡ŒåŠ å¯†ï¼Œç„¶åå¿…é¡»è¦å¯¹åº”çš„å…¬é’¥æ¥è¿›è¡Œè§£å¯†è®¤è¯æ‰èƒ½ç¡®ä¿æ•°æ®å®‰å…¨ã€‚å‰åŠå¥çš„åŠ å¯†è¿‡ç¨‹å°±å«åš &#39;æ•°å­—ç­¾å&#39;
1.3.2 æ•°å­—è¯ä¹¦è®¤è¯è¿‡ç¨‹ Alice æƒ³è¦é€šè¿‡è¯ä¹¦åŠ å¯†è®© Bob å®‰å…¨è¯»åˆ°è‡ªå·±çš„ä¿¡æ¯æµç¨‹å¦‚ä¸‹ï¼š
Alice åœ¨æœ¬åœ°ç”Ÿæˆ Private Key å’Œ CSRï¼ˆCertificate Signing Requestï¼‰ã€‚CSR ä¸­åŒ…å«äº† Alice çš„å…¬é’¥å’Œå§“åï¼Œæœºæ„ã€åœ°å€ç­‰èº«ä»½ä¿¡æ¯ã€‚ Alice ä½¿ç”¨è¯¥ CSR å‘è¯ä¹¦æœºæ„å‘èµ·æ•°å­—è¯ä¹¦ç”³è¯·ã€‚ è¯ä¹¦æœºæ„éªŒè¯ Alice çš„èº«ä»½åï¼Œä½¿ç”¨ CSR ä¸­çš„ä¿¡æ¯ç”Ÿæˆæ•°å­—è¯ä¹¦ï¼Œå¹¶ä½¿ç”¨è‡ªå·±çš„ CA æ ¹è¯ä¹¦å¯¹åº”çš„ç§é’¥å¯¹è¯¥è¯ä¹¦ç­¾åã€‚ Alice ä½¿ç”¨è‡ªå·±çš„ Private Key å¯¹åˆåŒè¿›è¡Œç­¾åï¼Œç„¶åå°†ç­¾ååçš„åˆåŒå’Œè‡ªå·±çš„è¯ä¹¦ä¸€èµ·å¹¶å‘é€ç»™ Bobã€‚ Bob ä½¿ç”¨æ“ä½œç³»ç»Ÿä¸­è‡ªå¸¦çš„è¯ä¹¦æœºæ„æ ¹è¯ä¹¦ä¸­çš„å…¬é’¥æ¥éªŒè¯ Alice è¯ä¹¦ä¸­çš„ç­¾åï¼Œä»¥ç¡®è®¤ Alice çš„èº«ä»½å’Œå…¬é’¥ã€‚(ä½¿ç”¨å†…ç½®æ ¹è¯ä¹¦ç¡®è®¤èº«ä»½å¹¶è·å–Aliceè¯ä¹¦) Alice çš„è¯ä¹¦éªŒè¯æˆåŠŸåï¼ŒBob ä½¿ç”¨ Alice è¯ä¹¦ä¸­çš„å…¬é’¥æ¥éªŒè¯åˆåŒä¸­æ•°å­—ç­¾åã€‚(ä½¿ç”¨åˆšåˆšè·å–çš„Aliceè¯ä¹¦(å…¬é’¥)è§£æAliceå‘é€çš„å†…å®¹) åˆåŒæ•°å­—ç­¾åé€šè¿‡éªŒè¯ï¼Œå¯ä»¥è¯æ˜è¯¥åˆåŒä¸º Alice æœ¬äººå‘é€ï¼Œå¹¶ä¸”ä¸­é—´æœªè¢«ç¬¬ä¸‰æ–¹ç¯¡æ”¹è¿‡ã€‚ æ³¨æ„ï¼š
          
          
        
      </description>
    </item>
    
    <item>
      <title>æµ…è°ˆkubernetes ingressæœºåˆ¶</title>
      <link>https://zhangsiming-blyq.github.io/post/ingress-mechanism/</link>
      <pubDate>Thu, 25 Aug 2022 00:00:00 +0000</pubDate>
      
      <guid>https://zhangsiming-blyq.github.io/post/ingress-mechanism/</guid>
      <description>
        
          
            ingressåœ¨å°†æµé‡å‘å¾€åç«¯çš„æ—¶å€™æ˜¯ä¸ç»è¿‡kube-proxyçš„ï¼Œingress controllerä¼šç›´æ¥å’Œkube-apiserverè¿›è¡Œäº¤äº’ï¼Œç„¶åè·å–pod endpointså’Œserviceçš„å¯¹åº”å…³ç³»ï¼Œè¿›è¡Œè½®è¯¢ï¼Œè´Ÿè½½å‡è¡¡åˆ°åç«¯èŠ‚ç‚¹ã€‚
ä¸€ã€éªŒè¯è¯•éªŒ ä»é›†ç¾¤ä¸­åˆ é™¤kube-proxyï¼ŒæŸ¥çœ‹é€šè¿‡ingressçš„æ–¹å¼æ˜¯å¦å¯ä»¥è®¿é—®æˆåŠŸ?
1# å®éªŒä¸­é€‰æ‹©çš„æ˜¯&amp;#34;iptablesæ¨¡å¼çš„kube-proxy&amp;#34; 2# é¦–å…ˆå…³é—­kube-proxy 3$ sudo systemctl stop kube-proxy 4 5# æŸ¥çœ‹æœåŠ¡ï¼ŒClusterIPçš„ç«¯å£æ˜¯8080ï¼ŒNodePortçš„ç«¯å£æ˜¯30948 6$ ks 7NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE 8example-test NodePort 10.0.0.226 &amp;lt;none&amp;gt; 8080:30948/TCP 18h 9traefik NodePort 10.0.0.85 &amp;lt;none&amp;gt; 9000:30001/TCP,80:30002/TCP,443:31990/TCP 19h 10 11# æŸ¥çœ‹ä¸&amp;#34;10.0.0.226&amp;#34;æœ‰å…³çš„iptablesæ¡ç›®ï¼Œå¾—çŸ¥è®¿é—®&amp;#34;10.0.0.226&amp;#34;ä¸”ç›®çš„ç«¯å£æ˜¯&amp;#34;8080&amp;#34;çš„æµé‡ä¼šå‘é€ç»™KUBE-SVC-KNYNFDNL67C7KAZZé“¾ 12$ sudo iptables -S -t nat | grep 10.0.0.226 13-A KUBE-SERVICES ! -s 10.0.0.0/24 -d 10.0.0.226/32 -p tcp -m comment --comment &amp;#34;traffic-dispatcher/example-test:port-8080 cluster IP&amp;#34; -m tcp --dport 8080 -j KUBE-MARK-MASQ 14-A KUBE-SERVICES -d 10.
          
          
        
      </description>
    </item>
    
    <item>
      <title>client-go watchæ¥å£éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨é€€å‡ºæ€ä¹ˆåŠï¼Ÿ</title>
      <link>https://zhangsiming-blyq.github.io/post/retrywatcher/</link>
      <pubDate>Sat, 28 May 2022 00:00:00 +0000</pubDate>
      
      <guid>https://zhangsiming-blyq.github.io/post/retrywatcher/</guid>
      <description>
        
          
            åœ¨ä½¿ç”¨client-goçš„watchæ¥å£æ—¶å€™ç¢°åˆ°å¼‚å¸¸é€€å‡ºé—®é¢˜ï¼ŒæŸ¥äº†ä¸€ä¸‹googleæ²¡æœ‰å¤šå°‘ä¿¡æ¯ï¼Œäºæ˜¯æ‰’äº†ä¸€ä¸‹ä»£ç ï¼ŒæŠŠè‡ªå·±è¸©çš„å‘è®°å½•ä¸‹æ¥æ–¹ä¾¿ä»¥åè‡ªæŸ¥è‡ªçº ã€‚
ä½¿ç”¨client-go watchæ¥å£ ğŸ’¡ å…¨å±€çš„myclusteréƒ½ç­‰äº*kubernetes.Clientset 1. å¦‚ä½•watch ç”±äºkubernetesæ•´åˆäº†etcdçš„watchåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡watchæ“ä½œå»å»ºç«‹ä¸€ä¸ªé•¿è¿æ¥ï¼Œä¸æ–­çš„æ¥æ”¶æ•°æ®ï¼›è¿™ç§æ–¹å¼è¦ä¼˜äºæ™®é€šçš„åå¤è½®è¯¢è¯·æ±‚ï¼Œé™ä½serverç«¯çš„å‹åŠ›;
ä½¿ç”¨client-goè°ƒç”¨å¯¹åº”å¯¹è±¡çš„Watch()æ–¹æ³•ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªwatch.Eventå¯¹è±¡ï¼Œå¯ä»¥å¯¹å…¶ä½¿ç”¨ResultChan()æ¥å—watchåˆ°çš„å¯¹è±¡ã€‚
1pod, err := mycluster.Clusterclientset.CoreV1().Pods(appNamespace).Watch(context.TODO(), metav1.ListOptions{LabelSelector: label}) 2if err != nil { 3 log.Error(err) 4} 5... 6event, ok := &amp;lt;-pod.ResultChan() 7if !ok { 8 log.Error(err) 9} å¼‚å¸¸ï¼šwatchæ¥å£è‡ªåŠ¨æ–­å¼€ 1. ç°è±¡ åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œwatchæ“ä½œæŒç»­ä¸€æ®µæ—¶é—´å°±ä¼šè‡ªåŠ¨æ–­å¼€
2. æ’æŸ¥ æˆ‘ä»¬è¿›å…¥watchåŒ…é‡Œé¢æ‰¾åˆ°streamwatcher.goï¼Œå…¶ä¸­èŠ‚é€‰äº†ä¸€äº›é‡è¦ç‰‡æ®µï¼š
1type StreamWatcher struct { 2	sync.Mutex 3	source Decoder 4	reporter Reporter 5	result chan Event 6	stopped bool 7} 8... 9func NewStreamWatcher(d Decoder, r Reporter) *StreamWatcher { 10	sw := &amp;amp;StreamWatcher{ 11	source: d, 12	reporter: r, 13	// It&amp;#39;s easy for a consumer to add buffering via an extra 14	// goroutine/channel, but impossible for them to remove it, 15	// so nonbuffered is better.
          
          
        
      </description>
    </item>
    
    <item>
      <title>prometheus ç›‘æµ‹ kubernetes æ§åˆ¶å¹³é¢</title>
      <link>https://zhangsiming-blyq.github.io/post/monitor-control-plane/</link>
      <pubDate>Mon, 11 Apr 2022 00:00:00 +0000</pubDate>
      
      <guid>https://zhangsiming-blyq.github.io/post/monitor-control-plane/</guid>
      <description>
        
          
            å¯¹äº kubernetes é›†ç¾¤çš„æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œç›‘æ§æ˜¯å¿…è¦çš„, ä»–å¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å–åˆ°é›†ç¾¤çš„æ•´ä½“è´Ÿè½½å‹åŠ›ï¼Œå¹¶åœ¨æ ¸å¿ƒç»„ä»¶å‡ºé—®é¢˜çš„æ—¶å€™é…åˆå‘Šè­¦è®©ç®¡ç†å‘˜åŠæ—¶å‘ç°é—®é¢˜ï¼ŒåŠæ—¶å¤„ç†ï¼Œæ›´ç¨³å®šçš„ä¿è¯é›†ç¾¤çš„ç”Ÿå‘½å‘¨æœŸã€‚
ä¸€ã€Prometheus å¦‚ä½•è‡ªåŠ¨å‘ç° Kubernetes Metrics æ¥å£? prometheus æ”¶é›† kubernetes é›†ç¾¤ä¸­çš„æŒ‡æ ‡æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ crd(servicemonitors.monitoring.coreos.com)çš„æ–¹å¼ï¼Œä¸»è¦é€šè¿‡æ ‡ç­¾åŒ¹é…ï¼›å¦ä¸€ç§æ˜¯é€šè¿‡ scrape_configï¼Œæ”¯æŒæ ¹æ®é…ç½®å¥½çš„&amp;quot;relabel_configs&amp;quot;ä¸­çš„å…·ä½“ç›®æ ‡, è¿›è¡Œä¸æ–­æ‹‰å–(æ‹‰å–é—´éš”ä¸º&amp;quot;scrape_interval&amp;quot;)
é…ç½®æƒé™ï¼š k8s ä¸­ RBAC æ”¯æŒæˆæƒèµ„æºå¯¹è±¡çš„æƒé™ï¼Œæ¯”å¦‚å¯ä»¥ getã€listã€watch é›†ç¾¤ä¸­çš„ podï¼Œè¿˜æ”¯æŒç›´æ¥èµ‹äºˆå¯¹è±¡è®¿é—® api è·¯å¾„çš„æƒé™ï¼Œæ¯”å¦‚è·å–/healthz, /api ç­‰, å®˜æ–¹å¯¹äº non_resource_urls çš„è§£é‡Šå¦‚ä¸‹ï¼š
non_resource_urls - (Optional) NonResourceURLs is a set of partial urls that a user should have access to. *s are allowed, but only as the full, final step in the path Since non-resource URLs are not namespaced, this field is only applicable for ClusterRoles referenced from a ClusterRoleBinding.
          
          
        
      </description>
    </item>
    
    <item>
      <title>æµ…è°ˆ containerd</title>
      <link>https://zhangsiming-blyq.github.io/post/containerd/</link>
      <pubDate>Sun, 10 Apr 2022 00:00:00 +0000</pubDate>
      
      <guid>https://zhangsiming-blyq.github.io/post/containerd/</guid>
      <description>
        
          
            ä¼´éšç€kuberneteså¯¹dockerçš„å¼ƒç”¨ï¼Œcontainerdå¼€å§‹è¿›å…¥å¤§ä¼—è§†é‡ï¼›ç›¸æ¯”äºkubeletä¸­é›†æˆdocker-shimè¿æ¥dockerï¼Œdockerå†æ¬¡æ¡ç”¨containerdå»ç®¡ç†å®¹å™¨ï¼Œç›´æ¥ä½¿ç”¨containerdå¯ä»¥é€šè¿‡åŸç”ŸCRIæ¥å£çš„è°ƒç”¨å®ç°å®¹å™¨runtimeï¼Œç®€åŒ–äº†è°ƒç”¨é“¾è·¯ï¼Œæ›´åŠ çš„çµæ´»å¯é ã€‚
ä¸€ã€å®‰è£…ä½¿ç”¨ ctr ç®¡ç† containerd 1# Install Dependent Libraries 2$ sudo apt-get update 3$ sudo apt-get install libseccomp2 4 5# ä¸‹è½½ 6# ç›®å‰æ˜¯ä¸‹è½½çš„1.5.2 7$ wget https://github.com/containerd/containerd/releases/download/v${VERSION}/cri-containerd-cni-${VERSION}-linux-amd64.tar.gz 8 9# å®‰è£… 10$ sudo tar --no-overwrite-dir -C / -xzf cri-containerd-cni-${VERSION}-linux-amd64.tar.gz 11# åˆå§‹åŒ–containerdé…ç½® 12$ containerd config default &amp;gt; /etc/containerd/config.toml 13# ä¿®æ”¹é»˜è®¤çš„sandbox_image 14$ vim /etc/containerd/config.toml 15... 16sandbox_image = &amp;#34;registry.cn-beijing.aliyuncs.com/shannonai-k8s/pause:3.1&amp;#34; 17... 18 19# å¯åŠ¨æœåŠ¡ 20sudo systemctl daemon-reload 21sudo systemctl start containerd 22 23# æŸ¥çœ‹ç‰ˆæœ¬ 24$ ctr version 25Client: 26 Version: 1.
          
          
        
      </description>
    </item>
    
  </channel>
</rss>
