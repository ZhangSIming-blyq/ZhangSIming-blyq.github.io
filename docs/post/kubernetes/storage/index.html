
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  >
  <head>
<title>Kubernetes 存储管理 | </title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=XXXXXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'XXXXXXXXXX');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="1. Dynamic Provisioner 例子与完整流程介绍 原理概述 在 Kubernetes 中，动态 provisioner 是一个实现了 Provisioner 接口的控制器，用于自动化存储卷的创建。当用户提交 PVC (PersistentVolumeClaim) 时，provisioner …" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="@janedoe">
<meta name="twitter:title" content="Kubernetes 存储管理" />
<meta name="twitter:image" content="https://zhangsiming-blyq.github.io/images/thumbnail.png"/>
<meta property="og:url" content="https://zhangsiming-blyq.github.io/post/kubernetes/storage/" />
<meta property="og:title" content="Kubernetes 存储管理" />
<meta property="og:description" content="1. Dynamic Provisioner 例子与完整流程介绍 原理概述 在 Kubernetes 中，动态 provisioner 是一个实现了 Provisioner 接口的控制器，用于自动化存储卷的创建。当用户提交 PVC (PersistentVolumeClaim) 时，provisioner …" />
<meta property="og:image" content="https://zhangsiming-blyq.github.io/images/thumbnail.png" />

<link rel="apple-touch-icon" sizes="180x180" href="https://zhangsiming-blyq.github.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://zhangsiming-blyq.github.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://zhangsiming-blyq.github.io/icons/site.webmanifest">

<link rel="canonical" href="https://zhangsiming-blyq.github.io/post/kubernetes/storage/">



<link rel="preload" href="https://zhangsiming-blyq.github.io/css/styles.42e2c5f6d8cf9c52872666f8d8b2678ad0c426978b9d78aff3c33b7a1e7f6f97f54bcdaf0518a25fb0fe26367d04f8b07c683b3b38b331cb098daadee06b1f3e.css" integrity = "sha512-QuLF9tjPnFKHJmb42LJnitDEJpeLnXiv88M7eh5/b5f1S82vBRiiX7D&#43;JjZ9BPiwfGg7OzizMcsJjare4GsfPg==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://zhangsiming-blyq.github.io/en/js/bundle.daf5d72d10b0f1e048706d4cb8d79d1ec41c3b5edcd83acfaa4df80252afff936252c1fa7804d8dcdb500eaf0f7d5adbb79cfe886cf7068f12f58cdebc05e1c3.js" as="script" integrity=
"sha512-2vXXLRCw8eBIcG1MuNedHsQcO17c2DrPqk34AlKv/5NiUsH6eATY3NtQDq8PfVrbt5z&#43;iGz3Bo8S9YzevAXhww==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://zhangsiming-blyq.github.io/css/styles.42e2c5f6d8cf9c52872666f8d8b2678ad0c426978b9d78aff3c33b7a1e7f6f97f54bcdaf0518a25fb0fe26367d04f8b07c683b3b38b331cb098daadee06b1f3e.css" integrity="sha512-QuLF9tjPnFKHJmb42LJnitDEJpeLnXiv88M7eh5/b5f1S82vBRiiX7D&#43;JjZ9BPiwfGg7OzizMcsJjare4GsfPg==" crossorigin="anonymous">


  </head>
  <body
    data-code="100000"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://zhangsiming-blyq.github.io/' class="nav_brand nav_item" title="">
  <img src="https://zhangsiming-blyq.github.io/logos/bailiyingqi.png" class="logo" alt="">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://zhangsiming-blyq.github.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://zhangsiming-blyq.github.io/archives/" class="nav_item" title="Archives">Archives </a>
  </div>
  <div class="nav_parent">
    <a href="https://zhangsiming-blyq.github.io/about/" class="nav_item" title="About">About </a>
  </div>
      
      <div class="nav_parent">
        <a href="#" class="nav_item"></a>
        <div class="nav_sub">
          <span class="nav_child"></span>
          
          <a href="https://zhangsiming-blyq.github.io/" class="nav_child nav_item"></a>
          
          <a href="https://zhangsiming-blyq.github.io/zh-cn/" class="nav_child nav_item"></a>
          
        </div>
      </div>
<div class='follow'>
  <a href="https://www.instagram.com/zhangsiming_bailiyingqi/">
    <svg class="icon">
  <title>instagram</title>
  <use xlink:href="#instagram"></use>
</svg>

  </a>
  <a href="https://twitter.com/Siming78740702">
    <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

  </a>
  <a href="https://github.com/ZhangSIming-blyq">
    <svg class="icon">
  <title>github</title>
  <use xlink:href="#github"></use>
</svg>

  </a>
    
  <a href="https://zhangsiming-blyq.github.io/index.xml">
    <svg class="icon">
  <title>rss</title>
  <use xlink:href="#rss"></use>
</svg>

  </a>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">Kubernetes 存储管理</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      Oct 8, 2024</span>
    <span class="post_time"> · 20 min read</span><span>&nbsp;· <a href='https://zhangsiming-blyq.github.io/tags/kubernetes/' title="kubernetes" class="post_tag button button_translucent">kubernetes
        </a><a href='https://zhangsiming-blyq.github.io/tags/%E4%B8%AD%E6%96%87/' title="中文" class="post_tag button button_translucent">中文
        </a>
    </span>
    <span class="page_only">&nbsp;·
  <div class="post_share">
    Share on:
    <a href="https://twitter.com/intent/tweet?text=Kubernetes%20%e5%ad%98%e5%82%a8%e7%ae%a1%e7%90%86&url=https%3a%2f%2fzhangsiming-blyq.github.io%2fpost%2fkubernetes%2fstorage%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

    </a>
    <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fzhangsiming-blyq.github.io%2fpost%2fkubernetes%2fstorage%2f&t=Kubernetes%20%e5%ad%98%e5%82%a8%e7%ae%a1%e7%90%86" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>facebook</title>
  <use xlink:href="#facebook"></use>
</svg>

    </a>
    <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow">
      <svg class="icon">
  <title>linkedin</title>
  <use xlink:href="#linkedin"></use>
</svg>

    </a>
    <a href="https://zhangsiming-blyq.github.io/post/kubernetes/storage/" title="Copy Link" class="link link_yank">
      <svg class="icon">
  <title>copy</title>
  <use xlink:href="#copy"></use>
</svg>

    </a>
  </div>
  </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1-dynamic-provisioner-例子与完整流程介绍">1. Dynamic Provisioner 例子与完整流程介绍</a>
      <ul>
        <li><a href="#原理概述"><strong>原理概述</strong></a></li>
        <li><a href="#流程概述"><strong>流程概述</strong></a></li>
        <li><a href="#步骤-1-自定义-provisioner-代码实现"><strong>步骤 1: 自定义 Provisioner 代码实现</strong></a></li>
        <li><a href="#步骤-2-部署自定义-provisioner-到-kubernetes"><strong>步骤 2: 部署自定义 Provisioner 到 Kubernetes</strong></a></li>
        <li><a href="#步骤-3-创建-storageclass"><strong>步骤 3: 创建 StorageClass</strong></a></li>
        <li><a href="#步骤-4-rbac-权限配置"><strong>步骤 4: RBAC 权限配置</strong></a></li>
        <li><a href="#步骤-5-创建-pvc-来触发-provisioner"><strong>步骤 5: 创建 PVC 来触发 Provisioner</strong></a></li>
      </ul>
    </li>
    <li><a href="#2-storageclass-所有字段及其功能介绍">2. StorageClass 所有字段及其功能介绍</a>
      <ul>
        <li><a href="#storageclass-示例-yaml"><strong>StorageClass 示例 YAML</strong></a></li>
        <li><a href="#字段解释及控制逻辑"><strong>字段解释及控制逻辑</strong></a></li>
        <li><a href="#字段与-controller-交互表格总结"><strong>字段与 Controller 交互表格总结</strong></a></li>
      </ul>
    </li>
    <li><a href="#3-整体挂载流程介绍attachdetachmountunmount">3. 整体挂载流程介绍：Attach、Detach、Mount、Unmount</a>
      <ul>
        <li><a href="#1-attach由-controllermanager-处理">1. <strong>Attach（由 ControllerManager 处理）</strong></a></li>
        <li><a href="#2-detach由-controllermanager-处理">2. <strong>Detach（由 ControllerManager 处理）</strong></a></li>
        <li><a href="#3-mount由-kubelet-处理">3. <strong>Mount（由 Kubelet 处理）</strong></a></li>
        <li><a href="#4-unmount由-kubelet-处理">4. <strong>Unmount（由 Kubelet 处理）</strong></a></li>
        <li><a href="#pod-磁盘挂载具体流程">Pod 磁盘挂载具体流程：</a></li>
      </ul>
    </li>
    <li><a href="#4-csi-驱动自主实现">4. CSI 驱动自主实现</a>
      <ul>
        <li><a href="#组件介绍">组件介绍</a></li>
        <li><a href="#代码组织结构">代码组织结构</a></li>
        <li><a href="#1-创建-pvc-并找到-csi-插件处理逻辑">1. <strong>创建 PVC 并找到 CSI 插件处理逻辑</strong></a></li>
        <li><a href="#2-初始化grpc服务器并上面说的三个csi服务">2. 初始化grpc服务器并上面说的三个csi服务</a></li>
        <li><a href="#3-external-provisioner-监听并调用-csi-插件的-createvolume-和-controllerpublishvolume">3. <strong><code>external-provisioner</code> 监听并调用 CSI 插件的 <code>CreateVolume</code> 和 <code>ControllerPublishVolume</code></strong></a></li>
        <li><a href="#4-pod-使用-pvc-触发-nodepublishvolume-挂载操作">4. <strong>Pod 使用 PVC 触发 <code>NodePublishVolume</code> 挂载操作</strong></a></li>
        <li><a href="#5-部署文件">5. <strong>部署文件</strong></a></li>
        <li><a href="#6-卷的卸载和资源的销毁">6. <strong>卷的卸载和资源的销毁</strong></a></li>
        <li><a href="#7-部署查看效果">7. 部署查看效果</a></li>
        <li><a href="#整体流程总结">整体流程总结：</a></li>
      </ul>
    </li>
    <li><a href="#5-provisioner-和-csi的区别">5. Provisioner 和 Csi的区别</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h2 id="1-dynamic-provisioner-例子与完整流程介绍">1. Dynamic Provisioner 例子与完整流程介绍</h2>
<h3 id="原理概述"><strong>原理概述</strong></h3>
<p>在 Kubernetes 中，动态 provisioner 是一个实现了 <code>Provisioner</code> 接口的控制器，用于自动化存储卷的创建。当用户提交 PVC (PersistentVolumeClaim) 时，provisioner 根据定义的 StorageClass，自动创建相应的 PV (PersistentVolume)。这种自动化存储管理机制大大简化了卷的生命周期管理，减少了手动操作的复杂性。</p>
<h3 id="流程概述"><strong>流程概述</strong></h3>
<p>自定义动态 provisioner 的流程包括以下几个步骤：</p>
<ol>
<li>创建自定义的 Provisioner 逻辑，负责监听 PVC 的创建事件，并生成 PV。</li>
<li>编写自定义的 StorageClass，使用该 Provisioner 动态创建卷。</li>
<li>编写控制器代码，处理卷的创建与删除。</li>
<li>部署自定义 provisioner 到 Kubernetes 集群中，并验证其功能。</li>
</ol>
<h3 id="步骤-1-自定义-provisioner-代码实现"><strong>步骤 1: 自定义 Provisioner 代码实现</strong></h3>
<p><a href="https://github.com/ZhangSIming-blyq/custom-provisioner">https://github.com/ZhangSIming-blyq/custom-provisioner</a></p>
<p>首先，我们通过 Go 语言编写一个简单的自定义 provisioner，模拟卷的创建和删除过程。核心是自定义Provisioner结构体，实现Provision和Delete方法。Provision方法用于创建卷，Delete方法用于删除卷。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl">
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">	<span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">	<span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">	<span class="s">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">	<span class="s">&#34;k8s.io/klog&#34;</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">	<span class="s">&#34;sigs.k8s.io/sig-storage-lib-external-provisioner/v7/controller&#34;</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">
</span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="kd">type</span> <span class="nx">customProvisioner</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">	<span class="c1">// Define any dependencies that your provisioner might need here, here I use the kubernetes client
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="c1"></span>	<span class="nx">client</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">
</span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="c1">// NewCustomProvisioner creates a new instance of the custom provisioner
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewCustomProvisioner</span><span class="p">(</span><span class="nx">client</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">Provisioner</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">	<span class="c1">// customProvisioner needs to implement &#34;Provision&#34; and &#34;Delete&#34; methods in order to satisfy the Provisioner interface
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">customProvisioner</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">		<span class="nx">client</span><span class="p">:</span> <span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">
</span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">customProvisioner</span><span class="p">)</span> <span class="nf">Provision</span><span class="p">(</span><span class="nx">options</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ProvisionOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ProvisioningState</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">	<span class="c1">// Validate the PVC spec, 0 storage size is not allowed
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="c1"></span>	<span class="nx">requestedStorage</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Requests</span><span class="p">[</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceStorage</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">	<span class="k">if</span> <span class="nx">requestedStorage</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ProvisioningFinished</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;requested storage size is zero&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">	<span class="c1">// If no access mode is specified, return an error
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">AccessModes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ProvisioningFinished</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;access mode is not specified&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">	<span class="c1">// Generate a unique name for the volume using the PVC namespace and name
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="c1"></span>	<span class="nx">volumeName</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;pv-%s-%s&#34;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">	<span class="c1">// Check if the volume already exists
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="c1"></span>	<span class="nx">volumePath</span> <span class="o">:=</span> <span class="s">&#34;/tmp/dynamic-volumes/&#34;</span> <span class="o">+</span> <span class="nx">volumeName</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">volumePath</span><span class="p">);</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ProvisioningFinished</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;volume %s already exists at %s&#34;</span><span class="p">,</span> <span class="nx">volumeName</span><span class="p">,</span> <span class="nx">volumePath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">	<span class="c1">// Create the volume directory
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">volumePath</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ProvisioningFinished</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create volume directory: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">	<span class="c1">// Based on the above checks, we can now create the PV, HostPath is used as the volume source
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="c1"></span>	<span class="nx">pv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">		<span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">			<span class="nx">Name</span><span class="p">:</span> <span class="nx">volumeName</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">		<span class="nx">Spec</span><span class="p">:</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">PersistentVolumeSpec</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">			<span class="nx">Capacity</span><span class="p">:</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">				<span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceStorage</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Requests</span><span class="p">[</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">ResourceStorage</span><span class="p">],</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">			<span class="nx">AccessModes</span><span class="p">:</span>                   <span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">AccessModes</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">			<span class="nx">PersistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">PersistentVolumeReclaimDelete</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">			<span class="nx">PersistentVolumeSource</span><span class="p">:</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">PersistentVolumeSource</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">				<span class="nx">HostPath</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">HostPathVolumeSource</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">					<span class="nx">Path</span><span class="p">:</span> <span class="nx">volumePath</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">	<span class="c1">// Return the PV, ProvisioningFinished and nil error to indicate success
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="c1"></span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Successfully provisioned volume %s for PVC %s/%s&#34;</span><span class="p">,</span> <span class="nx">volumeName</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">PVC</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">	<span class="k">return</span> <span class="nx">pv</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ProvisioningFinished</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">
</span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">customProvisioner</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">volume</span> <span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">	<span class="c1">// Validate whether the volume is a HostPath volume
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">HostPath</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Volume %s is not a HostPath volume, skipping deletion.&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">	<span class="c1">// Get the volume path
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="c1"></span>	<span class="nx">volumePath</span> <span class="o">:=</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">HostPath</span><span class="p">.</span><span class="nx">Path</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">	<span class="c1">// Check if the volume path exists
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">volumePath</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Volume path %s does not exist, nothing to delete.&#34;</span><span class="p">,</span> <span class="nx">volumePath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">	<span class="c1">// Delete the volume directory, using os.RemoveAll to delete the directory and its contents
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="c1"></span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Deleting volume %s at path %s&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">volumePath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">volumePath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to delete volume %s at path %s: %v&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">volumePath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">
</span></span><span class="line"><span class="ln">101</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Successfully deleted volume %s at path %s&#34;</span><span class="p">,</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">volumePath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">
</span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">	<span class="c1">// Use &#34;InClusterConfig&#34; to create a new clientset
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="c1"></span>	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">InClusterConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Failed to create in-cluster config: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">
</span></span><span class="line"><span class="ln">112</span><span class="cl">	<span class="nx">clientset</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Failed to create clientset: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">
</span></span><span class="line"><span class="ln">117</span><span class="cl">	<span class="nx">provisioner</span> <span class="o">:=</span> <span class="nf">NewCustomProvisioner</span><span class="p">(</span><span class="nx">clientset</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">118</span><span class="cl">
</span></span><span class="line"><span class="ln">119</span><span class="cl">	<span class="c1">// Important!! Create a new ProvisionController instance and run it; Once user creates a PVC, it would find the provisioner via storageClass&#39;s field &#34;provisioner&#34;.
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="c1"></span>	<span class="nx">pc</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">NewProvisionController</span><span class="p">(</span><span class="nx">clientset</span><span class="p">,</span> <span class="s">&#34;custom-provisioner&#34;</span><span class="p">,</span> <span class="nx">provisioner</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">LeaderElection</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Starting custom provisioner...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">	<span class="nx">pc</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="步骤-2-部署自定义-provisioner-到-kubernetes"><strong>步骤 2: 部署自定义 Provisioner 到 Kubernetes</strong></h3>
<p><strong>构建 Docker 镜像：</strong></p>
<p>首先，我们将上述代码打包成 Docker 镜像，以下是一个简单的 Dockerfile:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">FROM</span><span class="s"> golang:1.23 as builder</span><span class="err">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /workspace</span><span class="err">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /workspace/cmd/</span><span class="err">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -a -o custom-provisioner .<span class="err">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> alpine:3.14</span><span class="err">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /workspace/cmd/custom-provisioner /custom-provisioner<span class="err">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;/custom-provisioner&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p><strong>创建自定义 Provisioner 的 Deployment：</strong></p>
<p>这里因为我们要使用HostPath的tmp目录，所以需要在Deployment中挂载/tmp目录。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">siming.net/sre/custom-provisioner:main_dc62f09_2024-09-29-010124</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAMESPACE</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.namespace</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PROVISIONER_NAME</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span></code></pre></div><h3 id="步骤-3-创建-storageclass"><strong>步骤 3: 创建 StorageClass</strong></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-storage</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">custom</span><span class="w">
</span></span></span></code></pre></div><h3 id="步骤-4-rbac-权限配置"><strong>步骤 4: RBAC 权限配置</strong></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner-role</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;persistentvolumes&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;persistentvolumeclaims&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;delete&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;storage.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;storageclasses&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;events&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;patch&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner-binding</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-provisioner-role</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">system</span><span class="w">
</span></span></span></code></pre></div><h3 id="步骤-5-创建-pvc-来触发-provisioner"><strong>步骤 5: 创建 PVC 来触发 Provisioner</strong></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-pvc</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">custom-storage</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></div><p>当 PVC 被创建时，Kubernetes 将触发自定义 provisioner 来创建并绑定卷。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 成功部署custom-provisioner, 并且pod本地的tmp目录作为存储目录</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">kp
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME                                  READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">controller-manager-578b69d9d4-t228b   1/1     Running   <span class="m">0</span>          11d
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">custom-provisioner-58d77856f9-4m4l8   1/1     Running   <span class="m">0</span>          3m19s
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># 创建pvc后查看日志</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">k logs -f custom-provisioner-58d77856f9-4m4l8
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">I0928 17:25:36.663192       <span class="m">1</span> main.go:121<span class="o">]</span> Starting custom provisioner...
</span></span><span class="line"><span class="ln">10</span><span class="cl">I0928 17:25:36.663264       <span class="m">1</span> controller.go:810<span class="o">]</span> Starting provisioner controller custom-provisioner_custom-provisioner-58d77856f9-4m4l8_6328a9e1-cdeb-4088-b8e2-c83b140429e3!
</span></span><span class="line"><span class="ln">11</span><span class="cl">I0928 17:25:36.764192       <span class="m">1</span> controller.go:859<span class="o">]</span> Started provisioner controller custom-provisioner_custom-provisioner-58d77856f9-4m4l8_6328a9e1-cdeb-4088-b8e2-c83b140429e3!
</span></span><span class="line"><span class="ln">12</span><span class="cl">I0928 17:25:56.495556       <span class="m">1</span> controller.go:1413<span class="o">]</span> delete <span class="s2">&#34;pv-system-custom-pvc&#34;</span>: started
</span></span><span class="line"><span class="ln">13</span><span class="cl">I0928 17:25:56.495588       <span class="m">1</span> main.go:90<span class="o">]</span> Volume path /tmp/dynamic-volumes/pv-system-custom-pvc does not exist, nothing to delete.
</span></span><span class="line"><span class="ln">14</span><span class="cl">I0928 17:25:56.495598       <span class="m">1</span> controller.go:1428<span class="o">]</span> delete <span class="s2">&#34;pv-system-custom-pvc&#34;</span>: volume deleted
</span></span><span class="line"><span class="ln">15</span><span class="cl">I0928 17:25:56.502579       <span class="m">1</span> controller.go:1478<span class="o">]</span> delete <span class="s2">&#34;pv-system-custom-pvc&#34;</span>: persistentvolume deleted
</span></span><span class="line"><span class="ln">16</span><span class="cl">I0928 17:25:56.502604       <span class="m">1</span> controller.go:1483<span class="o">]</span> delete <span class="s2">&#34;pv-system-custom-pvc&#34;</span>: succeeded
</span></span><span class="line"><span class="ln">17</span><span class="cl">I0928 17:26:13.279654       <span class="m">1</span> controller.go:1279<span class="o">]</span> provision <span class="s2">&#34;system/custom-pvc&#34;</span> class <span class="s2">&#34;custom-storage&#34;</span>: started
</span></span><span class="line"><span class="ln">18</span><span class="cl">I0928 17:26:13.279822       <span class="m">1</span> main.go:74<span class="o">]</span> Successfully provisioned volume pv-system-custom-pvc <span class="k">for</span> PVC system/custom-pvc
</span></span><span class="line"><span class="ln">19</span><span class="cl">I0928 17:26:13.279839       <span class="m">1</span> controller.go:1384<span class="o">]</span> provision <span class="s2">&#34;system/custom-pvc&#34;</span> class <span class="s2">&#34;custom-storage&#34;</span>: volume <span class="s2">&#34;pv-system-custom-pvc&#34;</span> provisioned
</span></span><span class="line"><span class="ln">20</span><span class="cl">I0928 17:26:13.279855       <span class="m">1</span> controller.go:1397<span class="o">]</span> provision <span class="s2">&#34;system/custom-pvc&#34;</span> class <span class="s2">&#34;custom-storage&#34;</span>: succeeded
</span></span><span class="line"><span class="ln">21</span><span class="cl">I0928 17:26:13.279891       <span class="m">1</span> volume_store.go:212<span class="o">]</span> Trying to save persistentvolume <span class="s2">&#34;pv-system-custom-pvc&#34;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">I0928 17:26:13.280969       <span class="m">1</span> event.go:377<span class="o">]</span> Event<span class="o">(</span>v1.ObjectReference<span class="o">{</span>Kind:<span class="s2">&#34;PersistentVolumeClaim&#34;</span>, Namespace:<span class="s2">&#34;system&#34;</span>, Name:<span class="s2">&#34;custom-pvc&#34;</span>, UID:<span class="s2">&#34;8dc69c67-609b-48aa-b5d7-ae932f91a8d7&#34;</span>, APIVersion:<span class="s2">&#34;v1&#34;</span>, ResourceVersion:<span class="s2">&#34;3337346&#34;</span>, FieldPath:<span class="s2">&#34;&#34;</span><span class="o">})</span>: type: <span class="s1">&#39;Normal&#39;</span> reason: <span class="s1">&#39;Provisioning&#39;</span> External provisioner is provisioning volume <span class="k">for</span> claim <span class="s2">&#34;system/custom-pvc&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">I0928 17:26:13.297182       <span class="m">1</span> volume_store.go:219<span class="o">]</span> persistentvolume <span class="s2">&#34;pv-system-custom-pvc&#34;</span> saved
</span></span><span class="line"><span class="ln">24</span><span class="cl">I0928 17:26:13.297444       <span class="m">1</span> event.go:377<span class="o">]</span> Event<span class="o">(</span>v1.ObjectReference<span class="o">{</span>Kind:<span class="s2">&#34;PersistentVolumeClaim&#34;</span>, Namespace:<span class="s2">&#34;system&#34;</span>, Name:<span class="s2">&#34;custom-pvc&#34;</span>, UID:<span class="s2">&#34;8dc69c67-609b-48aa-b5d7-ae932f91a8d7&#34;</span>, APIVersion:<span class="s2">&#34;v1&#34;</span>, ResourceVersion:<span class="s2">&#34;3337346&#34;</span>, FieldPath:<span class="s2">&#34;&#34;</span><span class="o">})</span>: type: <span class="s1">&#39;Normal&#39;</span> reason: <span class="s1">&#39;ProvisioningSucceeded&#39;</span> Successfully provisioned volume pv-system-custom-pvc
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1"># 查看pvc</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">k get pvc 
</span></span><span class="line"><span class="ln">28</span><span class="cl">NAME         STATUS   VOLUME                 CAPACITY   ACCESS MODES   STORAGECLASS     AGE
</span></span><span class="line"><span class="ln">29</span><span class="cl">custom-pvc   Bound    pv-system-custom-pvc   1Gi        RWO            custom-storage   2m51s
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"># 已经动态绑定好pv</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">k get pv
</span></span><span class="line"><span class="ln">33</span><span class="cl">NAME                   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS     REASON   AGE
</span></span><span class="line"><span class="ln">34</span><span class="cl">pv-system-custom-pvc   1Gi        RWO            Delete           Bound    system/custom-pvc   custom-storage            2m53s
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="c1"># 目录也成功创建</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">ls /tmp/dynamic-volumes/  
</span></span><span class="line"><span class="ln">38</span><span class="cl">pv-system-custom-pvc
</span></span></code></pre></div><h2 id="2-storageclass-所有字段及其功能介绍">2. StorageClass 所有字段及其功能介绍</h2>
<h3 id="storageclass-示例-yaml"><strong>StorageClass 示例 YAML</strong></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-storage</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">example.com/custom-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">fast</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">us-east-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">replication-type</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">WaitForFirstConsumer</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nt">allowVolumeExpansion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">mountOptions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span>- <span class="l">discard</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span>- <span class="l">nobarrier</span><span class="w">
</span></span></span></code></pre></div><h3 id="字段解释及控制逻辑"><strong>字段解释及控制逻辑</strong></h3>
<h4 id="1-provisioner"><strong>1. <code>provisioner</code></strong></h4>
<ul>
<li>
<p><strong>功能</strong>:</p>
<ul>
<li><code>provisioner</code> 字段指定了用于动态创建卷的 provisioner。<strong><font color=seagreen>它决定了 Kubernetes 如何与外部存储系统交互</font></strong>。不同的 provisioner 可以对接不同类型的存储系统（如 AWS EBS、GCE Persistent Disks、自定义的 provisioner）。</li>
</ul>
</li>
<li>
<p><strong>受控组件</strong>:</p>
<ul>
<li><code>kube-controller-manager</code> 中的 PersistentVolume controller 负责根据该字段选择合适的 provisioner 实现，并向其发出创建卷的请求。该字段的值会与定义在集群中的 provisioner 匹配，例如 <code>example.com/custom-provisioner</code>。</li>
</ul>
</li>
</ul>
<h4 id="2-parameters"><strong>2. <code>parameters</code></strong></h4>
<ul>
<li>
<p><strong>功能</strong>:</p>
<ul>
<li><code>parameters</code> 字段用于向 provisioner 传递自定义参数。这些参数可以根据存储系统的特性进行定制。例如，<code>type</code> 参数可以定义存储类型（如高性能或标准存储），<code>zone</code> 参数可以定义存储卷的区域，<code>replication-type</code> 可以定义数据是否有复制策略。</li>
</ul>
</li>
<li>
<p><strong>受控组件</strong>:</p>
<ul>
<li><strong><font color=seagreen>由 provisioner 自身解析并使用这些参数</font></strong>，在创建 PV 时根据传递的参数设置存储卷的属性。例如，如果 provisioner 是自定义的，它需要解释 <code>parameters</code> 中的内容，并与存储系统交互以执行卷的创建。</li>
</ul>
</li>
</ul>
<h4 id="3-reclaimpolicy"><strong>3. <code>reclaimPolicy</code></strong></h4>
<ul>
<li>
<p><strong>功能</strong>:</p>
<ul>
<li>定义了当 PVC 被删除时，PV 的行为。选项包括：
<ul>
<li><code>Retain</code>: 卷不会被删除，数据保留。</li>
<li><code>Delete</code>: 卷会被删除，存储资源也会被释放。</li>
<li><strike><code>Recycle</code>: 卷会被擦除并返回到未绑定状态（在 Kubernetes 1.9 之后已废弃）。</strike></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>受控组件</strong>:</p>
<ul>
<li>由 <code>kube-controller-manager</code> 中的 PersistentVolume controller 管理。<strong><font color=seagreen>当 PVC 释放后，controller 根据 <code>reclaimPolicy</code> 执行相应的删除或保留操作。</font></strong></li>
</ul>
</li>
</ul>
<h4 id="4-volumebindingmode"><strong>4. <code>volumeBindingMode</code></strong></h4>
<ul>
<li>
<p><strong>功能</strong>:</p>
<ul>
<li>决定了 PVC 何时绑定到 PV。选项包括：
<ul>
<li><code>Immediate</code>: PVC 提交时立即绑定到可用的 PV。</li>
<li><code>WaitForFirstConsumer</code>: 仅在 Pod 被调度时才绑定 PV。这可以避免资源分配的不平衡问题，特别适用于多可用区环境下存储和计算资源的协同调度。先调度后绑定这种延迟绑定方式在pv有多种选择的时候，先根据pod的需求选择pv，避免调度冲突(pv调度和pod调度冲突)</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>受控组件</strong>:</p>
<ul>
<li><strong><font color=seagreen><code>kube-scheduler</code> 负责在 <code>WaitForFirstConsumer</code> 模式下，根据 Pod 调度的节点选择合适的 PV</font></strong>，并执行 PVC 的绑定。在 <code>Immediate</code> 模式下，PVC 和 PV 的绑定则由 <code>kube-controller-manager</code> 中的 PersistentVolume controller 处理。</li>
</ul>
</li>
</ul>
<h4 id="5-allowvolumeexpansion"><strong>5. <code>allowVolumeExpansion</code></strong></h4>
<ul>
<li>
<p><strong>功能</strong>:</p>
<ul>
<li>当该字段设置为 <code>true</code> 时，允许用户动态扩展已经绑定的卷的大小。如果 PVC 需要更多存储空间，可以通过修改 PVC 的规格来触发卷扩展。</li>
</ul>
</li>
<li>
<p><strong>受控组件</strong>:</p>
<ul>
<li><code>kube-controller-manager</code> 中的 <code>ExpandController</code> 负责处理卷扩展请求。当 PVC 被修改以请求更大的存储容量时，该 controller 会相应地对底层存储执行扩展操作，<strong><font color=seagreen>具体依赖于 storage provider 是否支持卷扩展</font></strong>。</li>
</ul>
</li>
</ul>
<h4 id="6-mountoptions"><strong>6. <code>mountOptions</code></strong></h4>
<ul>
<li>
<p><strong>功能</strong>:</p>
<ul>
<li>定义卷在挂载时的选项。例如，在上述示例中，<code>discard</code> 选项表示在卷删除时自动丢弃数据，<code>nobarrier</code> 选项用于提高写入性能。这些选项会影响卷的使用方式。</li>
</ul>
</li>
<li>
<p><strong>受控组件</strong>:</p>
<ul>
<li><code>kubelet</code> 负责在节点上处理挂载卷的操作。<strong><font color=seagreen><code>kubelet</code> 在实际挂载卷到 Pod 时，会使用 StorageClass 中定义的挂载选项。</font></strong></li>
</ul>
</li>
</ul>
<h3 id="字段与-controller-交互表格总结"><strong>字段与 Controller 交互表格总结</strong></h3>
<table>
<thead>
<tr>
<th>字段</th>
<th>作用</th>
<th>受控的组件</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>provisioner</code></td>
<td>指定动态卷 provisioner 使用哪个驱动</td>
<td><code>kube-controller-manager</code> 中的 PersistentVolume controller</td>
</tr>
<tr>
<td><code>parameters</code></td>
<td>向 provisioner 提供自定义参数</td>
<td>由 provisioner 自身逻辑解析</td>
</tr>
<tr>
<td><code>reclaimPolicy</code></td>
<td>卷删除后保留、回收或删除</td>
<td><code>kube-controller-manager</code> 中的 PersistentVolume controller</td>
</tr>
<tr>
<td><code>volumeBindingMode</code></td>
<td>PVC 何时绑定 PV</td>
<td><code>kube-scheduler</code> (等待消费者模式) 或 <code>kube-controller-manager</code> (立即绑定模式)</td>
</tr>
<tr>
<td><code>allowVolumeExpansion</code></td>
<td>允许扩展卷</td>
<td><code>ExpandController</code> 在 <code>kube-controller-manager</code> 中处理</td>
</tr>
<tr>
<td><code>mountOptions</code></td>
<td>卷挂载时的选项</td>
<td><code>kubelet</code> 负责挂载时的处理</td>
</tr>
</tbody>
</table>
<h2 id="3-整体挂载流程介绍attachdetachmountunmount">3. 整体挂载流程介绍：Attach、Detach、Mount、Unmount</h2>
<p>Kubernetes 中的存储卷挂载流程涉及两个主要组件：<strong>ControllerManager</strong> 和 <strong>Kubelet</strong>。每个阶段都有不同的控制器负责管理卷的挂载、卸载等操作。</p>
<h3 id="1-attach由-controllermanager-处理">1. <strong>Attach（由 ControllerManager 处理）</strong></h3>
<ul>
<li><strong>概述</strong>: 当一个 Pod 被调度到某个节点，并且该 Pod 需要使用 PersistentVolume（如 EBS 或 GCE Persistent Disk），<code>AttachDetachController</code> 会将卷附加（Attach）到该节点。</li>
<li><strong>过程</strong>:
<ol>
<li>Pod 被调度到某个节点。</li>
<li><code>AttachDetachController</code> 通过 Kubernetes API 获取 PVC 的相关信息，找到相应的 PersistentVolume。</li>
<li>使用 Cloud Provider 或者 CSI 驱动将卷附加到节点。(<strong><font color=tomato>调用csi的controller的controllerPublishVolume</font></strong>)</li>
<li>一旦卷附加成功，卷的状态将更新为 “Attached”，Pod 可以继续进入挂载阶段。</li>
</ol>
</li>
</ul>
<h3 id="2-detach由-controllermanager-处理">2. <strong>Detach（由 ControllerManager 处理）</strong></h3>
<ul>
<li><strong>概述</strong>: 当 Pod 被删除或调度到另一个节点时，<code>AttachDetachController</code> 会触发卷的卸载过程，将卷从原节点分离。</li>
<li><strong>过程</strong>:
<ol>
<li>当 Pod 终止时，<code>AttachDetachController</code> 检查卷是否仍然附加在节点上。</li>
<li>如果卷不再使用，控制器会通过 Cloud Provider 或 CSI 驱动将卷从节点上分离。</li>
<li>卷状态更新为 “Detached”，资源释放。</li>
</ol>
</li>
</ul>
<h3 id="3-mount由-kubelet-处理">3. <strong>Mount（由 Kubelet 处理）</strong></h3>
<ul>
<li><strong>概述</strong>: 当卷附加到节点后，<code>kubelet</code> 会将卷挂载到 Pod 的容器中，这个过程通过 <code>VolumeManager</code> 来管理。</li>
<li><strong>过程</strong>:
<ol>
<li><code>kubelet</code> 监控到卷已附加，准备进行挂载操作。</li>
<li><code>VolumeManager</code> 负责将卷挂载到宿主机的文件系统（如 <code>/var/lib/kubelet/pods/...</code> 路径）。</li>
<li>卷挂载完成后，卷可通过容器内的目录访问。</li>
</ol>
</li>
</ul>
<h3 id="4-unmount由-kubelet-处理">4. <strong>Unmount（由 Kubelet 处理）</strong></h3>
<ul>
<li><strong>概述</strong>: 当 Pod 删除时，<code>kubelet</code> 会将该卷从宿主机文件系统中卸载。</li>
<li><strong>过程</strong>:
<ol>
<li><code>VolumeManager</code> 检查到卷不再使用，准备卸载。</li>
<li><code>kubelet</code> 执行卸载操作，卷从宿主机文件系统中移除。</li>
<li>卸载完成后，卷资源释放，Pod 生命周期结束。</li>
</ol>
</li>
</ul>
<h3 id="pod-磁盘挂载具体流程">Pod 磁盘挂载具体流程：</h3>
<ol>
<li>用户创建 Pod 并指定 PVC。</li>
<li><strong>Attach</strong>: <code>AttachDetachController</code> 将卷附加到节点。</li>
<li><strong>Mount</strong>: <code>kubelet</code> 将卷挂载到节点，并将其映射到 Pod 的容器中。</li>
<li><strong>Unmount</strong>: 当 Pod 终止时，<code>kubelet</code> 执行卷的卸载操作。</li>
<li><strong>Detach</strong>: <code>AttachDetachController</code> 将卷从节点分离。</li>
</ol>
<p>要完整地理解 CSI（Container Storage Interface），我们可以通过编写一个简单的 CSI 驱动来演示其工作原理。这个例子将帮助你从基础层面理解 CSI 的各个组件：<strong>CSI Identity</strong>、<strong>CSI Controller</strong> 和 <strong>CSI Node</strong>。</p>
<h2 id="4-csi-驱动自主实现">4. CSI 驱动自主实现</h2>
<p><a href="https://github.com/ZhangSIming-blyq/hostpathcsi">https://github.com/ZhangSIming-blyq/hostpathcsi</a></p>
<h3 id="组件介绍">组件介绍</h3>
<p><figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="csi"
      
        class="image_figure image_internal image_unprocessed"
        src="/post/kubernetes/storage.png"
      
      
    />

    </picture>
</figure>
</p>
<p>一个 CSI 驱动包括三个主要部分：</p>
<ul>
<li><strong><font color=tomato>CSI Identity</font></strong>：提供驱动信息，如名称、版本和功能。</li>
<li><strong><font color=tomato>CSI Controller</font></strong>：管理卷的生命周期（创建、删除、扩展等）。</li>
<li><strong><font color=tomato>CSI Node</font></strong>：负责将卷挂载到节点或 Pod 中。</li>
</ul>
<p>kubernetes原生提供3个外部组件来与CSI驱动交互：</p>
<ul>
<li><strong><font color=tomato>csi-attacher</font></strong>：负责将卷附加到节点。</li>
<li><strong><font color=tomato>csi-provisioner</font></strong>：负责创建和删除卷。</li>
<li><strong><font color=tomato>csi-driver-registrar</font></strong>：负责注册 CSI 驱动。</li>
</ul>
<p>前两个要作为sidecar和csi-controller一起部署，后者作为sidecar和csi-node一起部署。都使用socket通信。</p>
<h3 id="代码组织结构">代码组织结构</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">.
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">├── LICENSE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">├── Makefile
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">├── README.md
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">├── cmd
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">│   └── main.go
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">├── deploy
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">│   ├── Dockerfile
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">│   ├── csi-controller.yaml
</span></span><span class="line"><span class="ln">10</span><span class="cl">│   ├── csi-node.yaml
</span></span><span class="line"><span class="ln">11</span><span class="cl">│   ├── pvc.yaml
</span></span><span class="line"><span class="ln">12</span><span class="cl">│   └── sc.yaml
</span></span><span class="line"><span class="ln">13</span><span class="cl">├── go.mod
</span></span><span class="line"><span class="ln">14</span><span class="cl">├── go.sum
</span></span><span class="line"><span class="ln">15</span><span class="cl">└── pkg
</span></span><span class="line"><span class="ln">16</span><span class="cl">    └── hostpathcsi
</span></span><span class="line"><span class="ln">17</span><span class="cl">        ├── controller.go
</span></span><span class="line"><span class="ln">18</span><span class="cl">        ├── identity.go
</span></span><span class="line"><span class="ln">19</span><span class="cl">        └── node.go
</span></span></code></pre></div><h3 id="1-创建-pvc-并找到-csi-插件处理逻辑">1. <strong>创建 PVC 并找到 CSI 插件处理逻辑</strong></h3>
<p>当用户创建一个 PVC（Persistent Volume Claim）时，Kubernetes 会根据 PVC 所指定的 <code>StorageClass</code> 找到对应的 CSI 插件。</p>
<h4 id="storageclass-的作用">StorageClass 的作用：</h4>
<ul>
<li><code>StorageClass</code> 定义了如何动态创建存储卷。其关键字段是 <code>provisioner</code>，指定了由哪个 CSI 驱动来处理存储卷的创建。</li>
<li>例如，<code>provisioner</code> 的值为 <code>hostpath.csi.k8s.io</code>，Kubernetes 会根据这个名称找到已注册的 CSI 驱动，并通过它来完成存储卷的操作。</li>
</ul>
<h4 id="csi-驱动注册">CSI 驱动注册：</h4>
<ul>
<li>在 Kubernetes 中，CSI 驱动通过 <code>CSIDriver</code> 对象进行注册。<code>CSIDriver</code> 对象保存了驱动的元数据信息，Kubernetes 通过它与 CSI 驱动进行交互。</li>
<li>例如，<code>csi-node-driver-registrar</code> 是一个负责在节点上注册 CSI 驱动的组件，它确保 Kubernetes 能识别并与节点上的 CSI 驱动通信。</li>
</ul>
<p>当 PVC 创建后，<code>StorageClass</code> 会告诉 Kubernetes 使用哪个 CSI 驱动来处理该卷的创建逻辑。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-pvc</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">custom-csi-sc </span><span class="w"> </span><span class="c"># 使用之前定义的 StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom-csi-sc</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">hostpath.csi.k8s.io </span><span class="w"> </span><span class="c"># 注意：这里的 provisioner 名字必须和你在 CSI 驱动中的名称一致</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">Immediate      </span><span class="w"> </span><span class="c"># 表示 PVC 立即绑定</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete             </span><span class="w"> </span><span class="c"># PVC 删除时删除卷</span><span class="w">
</span></span></span></code></pre></div><h3 id="2-初始化grpc服务器并上面说的三个csi服务">2. 初始化grpc服务器并上面说的三个csi服务</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="s">&#34;github.com/ZhangSIming-blyq/hostpathcsi/pkg/hostpathcsi&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;github.com/container-storage-interface/spec/lib/go/csi&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;google.golang.org/grpc&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	<span class="c1">// 先删除已存在的 socket 文件，这是因为 kubelet 会在 /var/lib/kubelet/plugins/hostpath.csi.k8s.io/ 目录下创建一个 socket 文件
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1"></span>	<span class="c1">// 先删除 socket 文件是为了确保新的进程可以绑定到同样的 socket 地址，避免因为旧的 socket 文件存在导致绑定失败或进程崩溃。
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>	<span class="c1">// Unix Socket 适用于本地进程间通信，效率更高，安全性好，适用于 CSI 驱动和 Kubelet 的通信场景。
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span>	<span class="c1">// IP 地址（TCP/IP Socket） 适用于跨主机的进程通信，主要用于需要远程通信的场景。
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"></span>	<span class="nx">socket</span> <span class="o">:=</span> <span class="s">&#34;/var/lib/kubelet/plugins/hostpath.csi.k8s.io/csi.sock&#34;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to remove existing socket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="nx">listener</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to listen on socket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="nx">server</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="c1">// 这里需要把三个服务注册到 gRPC 服务器上
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span>	<span class="nx">csi</span><span class="p">.</span><span class="nf">RegisterIdentityServer</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hostpathcsi</span><span class="p">.</span><span class="nx">IdentityServer</span><span class="p">{})</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">	<span class="nx">csi</span><span class="p">.</span><span class="nf">RegisterControllerServer</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hostpathcsi</span><span class="p">.</span><span class="nx">ControllerServer</span><span class="p">{})</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">	<span class="nx">csi</span><span class="p">.</span><span class="nf">RegisterNodeServer</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hostpathcsi</span><span class="p">.</span><span class="nx">NodeServer</span><span class="p">{})</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Starting CSI driver...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">	<span class="c1">// 启动 gRPC 服务器
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">listener</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to serve: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>identity是用于返回csi插件的详细信息，具备的能力等。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// pkg/hostpathcsi/identity.go
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">hostpathcsi</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="nx">csi</span> <span class="s">&#34;github.com/container-storage-interface/spec/lib/go/csi&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;k8s.io/klog&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">// IdentityServer 注意因为要作为csi.ControllerServer的实现，所以需要实现csi.ControllerServer的所有方法
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">IdentityServer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="nx">csi</span><span class="p">.</span><span class="nx">UnimplementedIdentityServer</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1">// GetPluginInfo 的作用是返回插件的信息，包括插件的名称和版本号
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">IdentityServer</span><span class="p">)</span> <span class="nf">GetPluginInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">GetPluginInfoRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">GetPluginInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received GetPluginInfo request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">GetPluginInfoResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">		<span class="c1">// csi要求插件的名称必顫是域名的逆序，这里使用了hostpath.csi.k8s.io
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="c1"></span>		<span class="nx">Name</span><span class="p">:</span>          <span class="s">&#34;hostpath.csi.k8s.io&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">		<span class="nx">VendorVersion</span><span class="p">:</span> <span class="s">&#34;v1.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1">// GetPluginCapabilities 的作用是返回插件的能力，这里只返回了 ControllerService 的能力; 也就是说，这个插件只实现了 ControllerService
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">IdentityServer</span><span class="p">)</span> <span class="nf">GetPluginCapabilities</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">GetPluginCapabilitiesRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">GetPluginCapabilitiesResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	<span class="c1">// 什么是ControllerService能力呢？ControllerService是CSI规范中的一个服务，它负责管理卷的生命周期，包括创建、删除、扩容等操作
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1"></span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received GetPluginCapabilities request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">GetPluginCapabilitiesResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		<span class="nx">Capabilities</span><span class="p">:</span> <span class="p">[]</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">PluginCapability</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">				<span class="nx">Type</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">PluginCapability_Service_</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">					<span class="nx">Service</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">PluginCapability_Service</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">						<span class="nx">Type</span><span class="p">:</span> <span class="nx">csi</span><span class="p">.</span><span class="nx">PluginCapability_Service_CONTROLLER_SERVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">					<span class="p">},</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">IdentityServer</span><span class="p">)</span> <span class="nf">Probe</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ProbeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ProbeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received Probe request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">
</span></span><span class="line"><span class="ln">47</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ProbeResponse</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="3-external-provisioner-监听并调用-csi-插件的-createvolume-和-controllerpublishvolume">3. <strong><code>external-provisioner</code> 监听并调用 CSI 插件的 <code>CreateVolume</code> 和 <code>ControllerPublishVolume</code></strong></h3>
<h4 id="external-provisioner-的作用"><code>external-provisioner</code> 的作用：</h4>
<ul>
<li><code>external-provisioner</code> 是一个外部组件，它监听集群中 PVC 的创建请求。它会根据 PVC 中引用的 <code>StorageClass</code> 和对应的 <code>provisioner</code> 字段，找到相关的 CSI 驱动。</li>
<li>当 <code>external-provisioner</code> 发现 PVC 时，会向 CSI 控制器发出 <code>CreateVolume</code> 请求。</li>
</ul>
<h4 id="createvolume-调用"><code>CreateVolume</code> 调用：</h4>
<ul>
<li><code>CreateVolume</code> 方法是 CSI Controller 侧的一个接口，负责在存储系统中创建卷。这是 PVC 动态分配卷的关键步骤。</li>
<li><code>CreateVolume</code> 的实现通常会在底层存储系统中实际分配卷，并返回卷的 ID 和其他相关元数据信息给 Kubernetes。</li>
</ul>
<h4 id="controllerpublishvolume-调用"><code>ControllerPublishVolume</code> 调用：</h4>
<ul>
<li>卷创建后，<code>ControllerPublishVolume</code> 负责将卷附加到指定的节点上。这通常是一个“模拟的”附加操作，特别是在 HostPath 这样的驱动中，它可能不涉及实际的物理附加，而是将卷关联到节点上。</li>
</ul>
<h4 id="pv-与-pvc-的绑定">PV 与 PVC 的绑定：</h4>
<ul>
<li>Kubernetes 的 PV（PersistentVolume）控制器会自动将创建好的卷绑定到 PVC 上，完成 PVC 和 PV 的关联。</li>
<li><code>external-provisioner</code> 调用 <code>CreateVolume</code> 和 <code>ControllerPublishVolume</code> 成功后，Kubernetes 会创建 PV，并将其绑定到相应的 PVC，完成存储卷的动态分配。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// pkg/hostpathcsi/controller.go
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1">// Package hostpathcsi Description: 这个服务主要实现的是Volume管理流程中的&#34;Provision阶段&#34;和&#34;Attach阶段&#34;的功能。
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">hostpathcsi</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">	<span class="nx">csi</span> <span class="s">&#34;github.com/container-storage-interface/spec/lib/go/csi&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	<span class="s">&#34;k8s.io/klog&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1">// ControllerServer 用于实现 ControllerService
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ControllerServer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="c1">// 继承默认的 ControllerServer
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>	<span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerServer</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1">// CreateVolume 用于创建卷, 具体的创建&#34;远程&#34;真的数据卷出来
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ControllerServer</span><span class="p">)</span> <span class="nf">CreateVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">CreateVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">CreateVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received CreateVolume request for %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">	<span class="c1">// 模拟 HostPath 卷的创建
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"></span>	<span class="nx">volumePath</span> <span class="o">:=</span> <span class="s">&#34;/tmp/csi/hostpath/&#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">volumePath</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create volume directory: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">CreateVolumeResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">		<span class="nx">Volume</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">Volume</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">			<span class="nx">VolumeId</span><span class="p">:</span>      <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">			<span class="nx">CapacityBytes</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">CapacityRange</span><span class="p">.</span><span class="nx">RequiredBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">			<span class="nx">VolumeContext</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Parameters</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="c1">// DeleteVolume 用于删除卷, 具体的删除&#34;远程&#34;真的数据卷
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ControllerServer</span><span class="p">)</span> <span class="nf">DeleteVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">DeleteVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">DeleteVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received DeleteVolume request for %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">VolumeId</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">
</span></span><span class="line"><span class="ln">42</span><span class="cl">	<span class="nx">volumePath</span> <span class="o">:=</span> <span class="s">&#34;/tmp/csi/hostpath/&#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">VolumeId</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">volumePath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to delete volume directory: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">
</span></span><span class="line"><span class="ln">47</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">DeleteVolumeResponse</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="c1">// ControllerPublishVolume 用于发布卷, 这个是Attach阶段的功能
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ControllerServer</span><span class="p">)</span> <span class="nf">ControllerPublishVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerPublishVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerPublishVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">	<span class="c1">// 在 HostPath 场景中，通常不需要 Controller 发布卷，因为它是本地存储
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;ControllerPublishVolume is not supported&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">
</span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="c1">// ControllerUnpublishVolume 用于取消发布卷, 这个是Detach阶段的功能
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ControllerServer</span><span class="p">)</span> <span class="nf">ControllerUnpublishVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerUnpublishVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerUnpublishVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;ControllerUnpublishVolume is not supported&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">
</span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="c1">// ControllerGetCapabilities 返回 Controller 的功能
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ControllerServer</span><span class="p">)</span> <span class="nf">ControllerGetCapabilities</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerGetCapabilitiesRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerGetCapabilitiesResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received ControllerGetCapabilities request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">	<span class="nx">capabilities</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerServiceCapability</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">			<span class="nx">Type</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerServiceCapability_Rpc</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">				<span class="nx">Rpc</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerServiceCapability_RPC</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">					<span class="nx">Type</span><span class="p">:</span> <span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerServiceCapability_RPC_CREATE_DELETE_VOLUME</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">				<span class="p">},</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">ControllerGetCapabilitiesResponse</span><span class="p">{</span><span class="nx">Capabilities</span><span class="p">:</span> <span class="nx">capabilities</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="4-pod-使用-pvc-触发-nodepublishvolume-挂载操作">4. <strong>Pod 使用 PVC 触发 <code>NodePublishVolume</code> 挂载操作</strong></h3>
<p>当一个 Pod 使用 PVC 时，Kubernetes 会调度该 Pod 到合适的节点，并触发 CSI 节点组件执行挂载操作。</p>
<h4 id="nodepublishvolume-的作用"><code>NodePublishVolume</code> 的作用：</h4>
<ul>
<li>当 Pod 被调度到节点并使用 PVC 时，<code>kubelet</code> 会与 <code>csi-node</code> 组件通信，触发 <code>NodePublishVolume</code> 操作。</li>
<li><code>NodePublishVolume</code> 负责将卷从存储系统挂载到节点的文件系统上，这样 Pod 就可以访问该存储卷。</li>
</ul>
<h4 id="挂载流程">挂载流程：</h4>
<ol>
<li>Kubernetes 调度 Pod 到合适的节点，该节点的 <code>kubelet</code> 负责协调卷的挂载。</li>
<li><code>kubelet</code> 会通过 CSI 驱动发出 <code>NodePublishVolume</code> 请求，要求将卷挂载到节点上的指定目录（如 <code>/var/lib/kubelet</code> 下的路径）。</li>
<li><code>NodePublishVolume</code> 成功完成后，卷挂载到节点，Pod 可以使用该卷进行读写操作。</li>
</ol>
<p><strong>重要提示</strong>：</p>
<ul>
<li>只有当 PVC 被 Pod 使用时，才会触发 <code>NodePublishVolume</code>。如果 PVC 没有被任何 Pod 使用，该方法不会被调用。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1">// pkg/hostpathcsi/node.go
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="c1">// Package hostpathcsi Description: 这个服务主要实现的是Volume管理流程中的&#34;NodePublishVolume阶段&#34;和&#34;NodeUnpublishVolume阶段&#34;的功能。
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="c1">// 对应Mount和Unmount操作
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">hostpathcsi</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">
</span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">	<span class="nx">csi</span> <span class="s">&#34;github.com/container-storage-interface/spec/lib/go/csi&#34;</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">	<span class="s">&#34;k8s.io/klog&#34;</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">	<span class="s">&#34;path/filepath&#34;</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">
</span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="kd">type</span> <span class="nx">NodeServer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">	<span class="nx">csi</span><span class="p">.</span><span class="nx">NodeServer</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">
</span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">NodeServer</span><span class="p">)</span> <span class="nf">NodePublishVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodePublishVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodePublishVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received NodePublishVolume request for %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">VolumeId</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">	<span class="nx">targetPath</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">TargetPath</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">	<span class="nx">sourcePath</span> <span class="o">:=</span> <span class="s">&#34;/tmp/csi/hostpath/&#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">VolumeId</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">	<span class="c1">// 检查源路径是否存在
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">sourcePath</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;source path %s does not exist&#34;</span><span class="p">,</span> <span class="nx">sourcePath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">	<span class="c1">// 检查目标路径的父目录是否存在，若不存在则创建
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="c1"></span>	<span class="nx">parentDir</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">parentDir</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create parent directory %s: %v&#34;</span><span class="p">,</span> <span class="nx">parentDir</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">	<span class="c1">// 检查目标路径是否存在
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">fi</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Lstat</span><span class="p">(</span><span class="nx">targetPath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">		<span class="c1">// 如果目标路径已经是符号链接，检查它是否指向正确的源路径
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">fi</span><span class="p">.</span><span class="nf">Mode</span><span class="p">()</span><span class="o">&amp;</span><span class="nx">os</span><span class="p">.</span><span class="nx">ModeSymlink</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">			<span class="nx">existingSource</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Readlink</span><span class="p">(</span><span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">existingSource</span> <span class="o">==</span> <span class="nx">sourcePath</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Target path %s already linked to correct source %s, skipping creation.&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">,</span> <span class="nx">sourcePath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">				<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodePublishVolumeResponse</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Target path %s is a symlink but points to %s, removing it.&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">,</span> <span class="nx">existingSource</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Target path %s exists but is not a symlink, removing it.&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">		<span class="c1">// 删除现有的文件或目录，避免冲突
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">targetPath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to remove existing target path %s: %v&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">	<span class="c1">// 创建软链接
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Symlink</span><span class="p">(</span><span class="nx">sourcePath</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create symlink from %s to %s: %v&#34;</span><span class="p">,</span> <span class="nx">sourcePath</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Volume %s successfully mounted to %s&#34;</span><span class="p">,</span> <span class="nx">sourcePath</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodePublishVolumeResponse</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">
</span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">NodeServer</span><span class="p">)</span> <span class="nf">NodeUnpublishVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeUnpublishVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeUnpublishVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received NodeUnpublishVolume request for %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">VolumeId</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">	<span class="nx">targetPath</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">TargetPath</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">	<span class="c1">// 检查目标路径是否存在且是软链接
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">fi</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Lstat</span><span class="p">(</span><span class="nx">targetPath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">		<span class="k">if</span> <span class="nx">fi</span><span class="p">.</span><span class="nf">Mode</span><span class="p">()</span><span class="o">&amp;</span><span class="nx">os</span><span class="p">.</span><span class="nx">ModeSymlink</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Target path %s is a symlink, removing it.&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">targetPath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to remove symlink at target path %s: %v&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Successfully removed symlink at %s&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Target path %s is not a symlink, skipping removal.&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Target path %s does not exist, skipping unpublish.&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error checking target path %s: %v&#34;</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeUnpublishVolumeResponse</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">
</span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">NodeServer</span><span class="p">)</span> <span class="nf">NodeGetInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeGetInfoRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeGetInfoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received NodeGetInfo request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">	<span class="c1">// 获取node的主机名
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="c1"></span>	<span class="nx">nodeID</span> <span class="o">:=</span> <span class="s">&#34;node1&#34;</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">	<span class="c1">// 可选：假如你支持Topologies，可以添加相关信息
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="c1"></span>	<span class="nx">topology</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">Topology</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">		<span class="nx">Segments</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">			<span class="s">&#34;topology.hostpath.csi/node&#34;</span><span class="p">:</span> <span class="nx">nodeID</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">
</span></span><span class="line"><span class="ln">102</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeGetInfoResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl">		<span class="nx">NodeId</span><span class="p">:</span>             <span class="nx">nodeID</span><span class="p">,</span>   <span class="c1">// 返回节点ID
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="c1"></span>		<span class="nx">AccessibleTopology</span><span class="p">:</span> <span class="nx">topology</span><span class="p">,</span> <span class="c1">// 返回可访问拓扑信息
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="c1"></span>	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">
</span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="c1">// NodeGetCapabilities 返回该节点的能力信息
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">NodeServer</span><span class="p">)</span> <span class="nf">NodeGetCapabilities</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeGetCapabilitiesRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeGetCapabilitiesResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received NodeGetCapabilities request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">
</span></span><span class="line"><span class="ln">112</span><span class="cl">	<span class="c1">// 返回节点的能力信息，不包含 STAGE_UNSTAGE_VOLUME，表示跳过这个阶段
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="c1"></span>	<span class="nx">capabilities</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeServiceCapability</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">			<span class="nx">Type</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeServiceCapability_Rpc</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">				<span class="nx">Rpc</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeServiceCapability_RPC</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">					<span class="c1">// 不包含 STAGE_UNSTAGE_VOLUME，跳过该能力
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="c1"></span>					<span class="nx">Type</span><span class="p">:</span> <span class="nx">csi</span><span class="p">.</span><span class="nx">NodeServiceCapability_RPC_UNKNOWN</span><span class="p">,</span> <span class="c1">// 表示无特定能力
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="c1"></span>				<span class="p">},</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">
</span></span><span class="line"><span class="ln">124</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeGetCapabilitiesResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">		<span class="nx">Capabilities</span><span class="p">:</span> <span class="nx">capabilities</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">
</span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="c1">// NodeStageVolume 空实现，用于跳过该操作
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">NodeServer</span><span class="p">)</span> <span class="nf">NodeStageVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeStageVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeStageVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">131</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received NodeStageVolume request but this operation is not needed, skipping.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeStageVolumeResponse</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl">
</span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="c1">// NodeUnstageVolume 空实现，用于跳过该操作
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">NodeServer</span><span class="p">)</span> <span class="nf">NodeUnstageVolume</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeUnstageVolumeRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeUnstageVolumeResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">137</span><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Received NodeUnstageVolume request but this operation is not needed, skipping.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">138</span><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">csi</span><span class="p">.</span><span class="nx">NodeUnstageVolumeResponse</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="5-部署文件">5. <strong>部署文件</strong></h3>
<p>我们使用statefulset来保证csi-controller拓扑状态的稳定性，因为他严格按照顺序更新pod，只有前一个pod停止并且删除后才会创建启动下一个pod；同时要做好RBAC。</p>
<p>对于csi-node，因为要和本地的kubelet交互，我们使用daemonset来保证每个节点都有一个pod。通信使用socket，要挂载到/var/lib/kubelet/plugins/hostpath.csi.k8s.io/目录下。对于容器内完成挂载链接的操作要设置mountPropagation: Bidirectional来保证双边的可见性。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;csi-controller&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller-sa</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">siming.net/sre/custom-csi:main_de5c0f9_2024-10-08-231124</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">socket-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/plugins/hostpath.csi.k8s.io/</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">              </span><span class="nt">mountPropagation</span><span class="p">:</span><span class="w"> </span><span class="l">Bidirectional</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pods-dir </span><span class="w"> </span><span class="c"># 挂载 /var/lib/kubelet/pods 目录</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/pods</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">              </span><span class="nt">mountPropagation</span><span class="p">:</span><span class="w"> </span><span class="l">Bidirectional</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir </span><span class="w"> </span><span class="c"># 挂载 /tmp 目录</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">              </span><span class="nt">mountPropagation</span><span class="p">:</span><span class="w"> </span><span class="l">Bidirectional</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">external-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/k8scsi/csi-provisioner:v2.0.0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">            </span>- <span class="s2">&#34;--csi-address=/csi/csi.sock&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span>- <span class="s2">&#34;--leader-election=true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">socket-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/csi</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">external-attacher</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/k8scsi/csi-attacher:v3.0.0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">            </span>- <span class="s2">&#34;--csi-address=/csi/csi.sock&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">            </span>- <span class="s2">&#34;--leader-election=true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">socket-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/csi</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">socket-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/plugins/hostpath.csi.k8s.io/</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pods-dir </span><span class="w"> </span><span class="c"># 宿主机 /var/lib/kubelet/pods 目录挂载</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/pods</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volumes-dir </span><span class="w"> </span><span class="c"># 宿主机 /var/lib/kubelet/volumes 目录挂载</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/volumes</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir </span><span class="w"> </span><span class="c"># 宿主机 /tmp 目录挂载</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller-sa</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller-role</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;persistentvolumeclaims&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;persistentvolumes&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;nodes&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;storage.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;storageclasses&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;volumeattachments&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;csinodes&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;create&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;storage.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;volumeattachments/status&#34;</span><span class="p">]</span><span class="w">  </span><span class="c"># 增加对 volumeattachments/status 的 patch 权限</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;patch&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;events&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;patch&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;coordination.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;leases&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;patch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;create&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller-binding</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller-role</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-controller-sa</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-node</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">csi-node</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">csi-node</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">csi-node</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">csi-node-sa</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-node</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">siming.net/sre/custom-csi:main_de5c0f9_2024-10-08-170548</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">plugin-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/plugins/hostpath.csi.k8s.io/</span><span class="w">
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="w">              </span><span class="nt">mountPropagation</span><span class="p">:</span><span class="w"> </span><span class="l">Bidirectional</span><span class="w">
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pods-mount-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/pods</span><span class="w">
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="w">              </span><span class="nt">mountPropagation</span><span class="p">:</span><span class="w"> </span><span class="l">HostToContainer</span><span class="w">
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir </span><span class="w"> </span><span class="c"># 挂载 /tmp 目录</span><span class="w">
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="w">              </span><span class="nt">mountPropagation</span><span class="p">:</span><span class="w"> </span><span class="l">Bidirectional</span><span class="w">
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">csi-driver-registrar</span><span class="w">
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/k8scsi/csi-node-driver-registrar:v2.0.0</span><span class="w">
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="w">            </span>- <span class="s2">&#34;--csi-address=/csi/csi.sock&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">157</span><span class="cl"><span class="w">            </span>- <span class="s2">&#34;--kubelet-registration-path=/var/lib/kubelet/plugins/hostpath.csi.k8s.io/csi.sock&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">158</span><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">159</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">plugin-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">160</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/csi</span><span class="w">
</span></span></span><span class="line"><span class="ln">161</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">registration-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">162</span><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/registration</span><span class="w">
</span></span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">164</span><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">plugin-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/plugins/hostpath.csi.k8s.io/</span><span class="w">
</span></span></span><span class="line"><span class="ln">168</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w">
</span></span></span><span class="line"><span class="ln">169</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pods-mount-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/pods</span><span class="w">
</span></span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w">
</span></span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">registration-dir</span><span class="w">
</span></span></span><span class="line"><span class="ln">174</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">175</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/kubelet/plugins_registry/</span><span class="w">
</span></span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w">
</span></span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir </span><span class="w"> </span><span class="c"># 宿主机 /tmp 目录挂载</span><span class="w">
</span></span></span><span class="line"><span class="ln">178</span><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">179</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="ln">180</span><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span></code></pre></div><h3 id="6-卷的卸载和资源的销毁">6. <strong>卷的卸载和资源的销毁</strong></h3>
<h4 id="卸载卷nodeunpublishvolume">卸载卷（<code>NodeUnpublishVolume</code>）：</h4>
<ul>
<li>当 Pod 被删除或停止时，<code>kubelet</code> 会请求卸载卷，触发 <code>NodeUnpublishVolume</code> 方法。</li>
<li><code>NodeUnpublishVolume</code> 负责从节点文件系统中卸载卷，并删除挂载路径上的符号链接或执行卸载命令。</li>
</ul>
<h4 id="删除存储卷deletevolume">删除存储卷（<code>DeleteVolume</code>）：</h4>
<ul>
<li>当用户删除 PVC 后，Kubernetes 会调用 CSI 驱动的 <code>DeleteVolume</code> 方法，删除后端存储中的卷。</li>
<li><code>DeleteVolume</code> 的作用是释放底层存储资源并删除与该卷相关的元数据。</li>
<li><code>external-provisioner</code> 在监听到 PVC 删除后，会与 CSI Controller 交互，通过 <code>DeleteVolume</code> 完成存储卷的回收和删除操作。</li>
</ul>
<h4 id="反向流程">反向流程：</h4>
<ul>
<li>当 Pod 停止使用 PVC 时，Kubernetes 会逐步执行卷的卸载过程，通过 <code>NodeUnpublishVolume</code> 完成从节点的卸载。</li>
<li>当 PVC 被删除时，<code>external-provisioner</code> 调用 <code>DeleteVolume</code> 来释放存储资源。</li>
</ul>
<h3 id="7-部署查看效果">7. 部署查看效果</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 模拟创建</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">k apply -f pvc.yaml
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">persistentvolumeclaim/custom-pvc created
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">k apply -f demo.yaml 
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">pod/my-pod-1 created
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">k get pvc
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span class="line"><span class="ln">10</span><span class="cl">custom-pvc   Bound    pvc-dce4da52-28cf-4514-854e-545df5a31a29   1Gi        RWO            custom-csi-sc   5s
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"> sudo touch /tmp/csi/hostpath/pvc-dce4da52-28cf-4514-854e-545df5a31a29/testfile               
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">kp
</span></span><span class="line"><span class="ln">15</span><span class="cl">NAME                                      READY   STATUS      RESTARTS   AGE
</span></span><span class="line"><span class="ln">16</span><span class="cl">calico-kube-controllers-5b564d9b7-5lbrn   1/1     Running     <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">17</span><span class="cl">canal-lxk8w                               2/2     Running     <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">18</span><span class="cl">coredns-54cc789d79-mrbpb                  1/1     Running     <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">19</span><span class="cl">coredns-autoscaler-6ff6bf758-hrxmh        1/1     Running     <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">20</span><span class="cl">csi-controller-0                          3/3     Running     <span class="m">0</span>          10h
</span></span><span class="line"><span class="ln">21</span><span class="cl">csi-node-wmsq7                            2/2     Running     <span class="m">0</span>          16h
</span></span><span class="line"><span class="ln">22</span><span class="cl">metrics-server-657c74b5d8-jjxzd           1/1     Running     <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">23</span><span class="cl">my-pod-1                                  1/1     Running     <span class="m">0</span>          17s
</span></span><span class="line"><span class="ln">24</span><span class="cl">rke-coredns-addon-deploy-job-rmw2r        0/1     Completed   <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">25</span><span class="cl">rke-ingress-controller-deploy-job-2z4d6   0/1     Completed   <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">26</span><span class="cl">rke-metrics-addon-deploy-job-9bs7c        0/1     Completed   <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">27</span><span class="cl">rke-network-plugin-deploy-job-2pzvs       0/1     Completed   <span class="m">0</span>          33d
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">k <span class="nb">exec</span> -it my-pod-1 ls /mnt/data   
</span></span><span class="line"><span class="ln">30</span><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="ln">31</span><span class="cl">testfile
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="c1"># 模拟删除</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">kdel -f demo.yaml   
</span></span><span class="line"><span class="ln">35</span><span class="cl">warning: Immediate deletion does not <span class="nb">wait</span> <span class="k">for</span> confirmation that the running resource has been terminated. The resource may <span class="k">continue</span> to run on the cluster indefinitely.
</span></span><span class="line"><span class="ln">36</span><span class="cl">pod <span class="s2">&#34;my-pod-1&#34;</span> force deleted
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">kdel -f pvc.yaml  
</span></span><span class="line"><span class="ln">39</span><span class="cl">warning: Immediate deletion does not <span class="nb">wait</span> <span class="k">for</span> confirmation that the running resource has been terminated. The resource may <span class="k">continue</span> to run on the cluster indefinitely.
</span></span><span class="line"><span class="ln">40</span><span class="cl">persistentvolumeclaim <span class="s2">&#34;custom-pvc&#34;</span> force deleted
</span></span><span class="line"><span class="ln">41</span><span class="cl">
</span></span><span class="line"><span class="ln">42</span><span class="cl">ls /tmp/csi/hostpath 
</span></span></code></pre></div><h3 id="整体流程总结">整体流程总结：</h3>
<ol>
<li>
<p><strong>PVC 创建</strong>：</p>
<ul>
<li>用户创建 PVC 并指定 <code>StorageClass</code>。<code>StorageClass</code> 的 <code>provisioner</code> 字段指定了哪个 CSI 驱动负责处理卷。</li>
<li><code>external-provisioner</code> 监听 PVC 事件，并通过 <code>provisioner</code> 字段找到相应的 CSI 插件。</li>
</ul>
</li>
<li>
<p><strong>卷的创建和附加</strong>：</p>
<ul>
<li><code>external-provisioner</code> 调用 <code>csi-controller</code> 的 <code>CreateVolume</code> 方法，创建存储卷。</li>
<li><code>ControllerPublishVolume</code> 将卷附加到节点。</li>
</ul>
</li>
<li>
<p><strong>Pod 使用 PVC 触发卷挂载</strong>：</p>
<ul>
<li>当 Pod 使用 PVC 时，<code>kubelet</code> 通过 <code>NodePublishVolume</code> 请求将卷挂载到节点。</li>
<li>Pod 可以在挂载成功后使用该卷进行数据读写。</li>
</ul>
</li>
<li>
<p><strong>卸载与删除</strong>：</p>
<ul>
<li>当 Pod 停止或删除时，<code>NodeUnpublishVolume</code> 卸载卷。</li>
<li>当 PVC 被删除时，<code>DeleteVolume</code> 删除卷，并释放底层存储资源。</li>
</ul>
</li>
</ol>
<p>这个过程描述了从 PVC 的创建、卷的动态分配、Pod 使用卷，再到卷的卸载和删除的完整生命周期。</p>
<h2 id="5-provisioner-和-csi的区别">5. Provisioner 和 Csi的区别</h2>
<table>
<thead>
<tr>
<th><strong>分类</strong></th>
<th><strong>Provisioner</strong></th>
<th><strong>CSI (Container Storage Interface)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>定义</strong></td>
<td>Provisioner 是负责动态或静态分配存储卷的组件。可以是基于 CSI 也可以不是。</td>
<td>CSI 是一种标准接口，定义了 Kubernetes 如何与存储系统交互，通常用于动态卷管理。</td>
</tr>
<tr>
<td><strong>工作机制</strong></td>
<td>Provisioner 监听 PVC 事件，动态或静态创建 PV，绑定 PVC。可以是 CSI 驱动的 <code>external-provisioner</code>，也可以是传统非 CSI 的 Provisioner。</td>
<td>CSI 通过标准接口与 Kubernetes 交互，提供卷的创建、挂载、卸载等功能，实际操作由存储插件实现。</td>
</tr>
<tr>
<td><strong>通用性</strong></td>
<td>Provisioner 可以是非 CSI 方案，例如基于传统存储系统的动态分配机制。也可以支持静态预创建的 PV。</td>
<td>CSI 是专门为容器环境设计的通用存储接口，支持任何遵循 CSI 标准的存储系统。</td>
</tr>
<tr>
<td><strong>工作方式</strong></td>
<td>Provisioner 可以通过 StorageClass 中的 <code>provisioner</code> 字段指定，动态分配存储卷，不一定依赖 CSI，可以是特定存储厂商的原生方案。</td>
<td>CSI 提供标准化接口，负责与 Kubernetes API 交互，执行卷的创建、挂载、卸载等，存储厂商通过实现 CSI 驱动来提供具体功能。</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>Provisioner 负责创建、管理 PV 和 PVC，提供了动态卷分配的能力，支持通过插件或内置机制实现（例如 <code>kubernetes.io/aws-ebs</code>）。</td>
<td>CSI 提供标准的 API 规范，允许 Kubernetes 与不同存储系统交互，完成卷管理。</td>
</tr>
<tr>
<td><strong>外部组件</strong></td>
<td><code>external-provisioner</code> 是典型的 CSI-based Provisioner，也有非 CSI 的动态 Provisioner 通过特定的 API 与 Kubernetes 交互。</td>
<td>CSI 是存储接口规范，具体的存储实现依赖不同的 CSI 驱动，负责处理存储的实际操作。</td>
</tr>
<tr>
<td><strong>动态 vs 静态</strong></td>
<td>动态 Provisioner 动态创建卷，静态 Provisioner 允许预创建卷并手动分配给 PVC。</td>
<td>CSI 一般用于动态存储卷分配，但也可以通过 PV 实现静态卷分配。</td>
</tr>
<tr>
<td><strong>示例</strong></td>
<td>1. 动态：<code>kubernetes.io/aws-ebs</code>，<code>nfs-client</code> 动态创建 PV。<br>2. 静态：手动创建 PV，绑定 PVC。</td>
<td>HostPath CSI、AWS EBS CSI、NFS CSI 等，可以通过 CSI 驱动创建和管理存储卷。</td>
</tr>
<tr>
<td><strong>适用范围</strong></td>
<td>适用于传统存储系统和非容器化存储，支持 Kubernetes 的动态存储分配。</td>
<td>适用于容器化环境，支持各种存储类型，标准化接口确保跨平台和跨供应商的存储兼容。</td>
</tr>
<tr>
<td><strong>主要职责</strong></td>
<td>1. 监听 PVC 创建请求<br>2. 调用 API 或存储系统接口创建 PV，绑定 PVC。</td>
<td>1. 提供跨存储供应商标准接口<br>2. 提供容器化环境中的存储卷管理操作。</td>
</tr>
<tr>
<td><strong>核心接口/方法</strong></td>
<td>- 动态：<code>Provision</code><br>- 静态：手动创建 PV 并绑定 PVC</td>
<td>- <code>NodePublishVolume</code><br>- <code>ControllerPublishVolume</code><br>- <code>CreateVolume</code></td>
</tr>
<tr>
<td><strong>优势</strong></td>
<td>动态 Provisioner 提供了非 CSI 环境下的动态存储卷管理。</td>
<td>CSI 通过标准化接口，支持广泛的存储系统和供应商，具有高度扩展性。</td>
</tr>
<tr>
<td><strong>典型场景</strong></td>
<td>动态：AWS EBS、GCE PD 等云供应商存储卷，NFS 动态卷客户端。<br>静态：预分配卷，管理员手动操作。</td>
<td>适用于支持 CSI 的存储系统，HostPath、GlusterFS、AWS EBS 等支持 CSI 的存储。</td>
</tr>
</tbody>
</table>
<p><strong><font color=yellowgreen>CSI 需要与 Provisioner 结合使用，但 Provisioner 不一定需要依赖 CSI。</font></strong></p>

    </div>
<div class="post_comments">
  
  
    
 <script src="https://utteranc.es/client.js"
         repo="ZhangSIming-blyq/blogcommit"
         issue-term="pathname"
         theme="github-light"
         crossorigin="anonymous"
         async>
 </script>
 
  
  
</div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>


    
    
    <h2 class="mt-4">Featured Posts</h2>
    <ul>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/kubernetes/storage/" class="nav-link" title="Kubernetes 存储管理">Kubernetes 存储管理</a>
      </li>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/golang/core/" class="nav-link" title="Golang 核心知识点详解文档">Golang 核心知识点详解文档</a>
      </li>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/kubernetes/gpu-operator/" class="nav-link" title="Kubernetes 中 GPU 虚拟化与 NVIDIA GPU Operator 管理概述">Kubernetes 中 GPU 虚拟化与 NVIDIA GPU Operator 管理概述</a>
      </li>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/kubernetes/cilium/" class="nav-link" title="Kubernetes 中 Cilium 网络架构详解与流量处理流程">Kubernetes 中 Cilium 网络架构详解与流量处理流程</a>
      </li>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/algorithm/mergeset/" class="nav-link" title="两个有序集合的合并">两个有序集合的合并</a>
      </li>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/golang/map/" class="nav-link" title="Go `map` 底层实现与冲突处理">Go <code>map</code> 底层实现与冲突处理</a>
      </li>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/golang/channel/" class="nav-link" title="Go Channel 是线程安全的吗？">Go Channel 是线程安全的吗？</a>
      </li>
      <li>
        <a href="https://zhangsiming-blyq.github.io/post/golang/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/" class="nav-link" title="Go内存逃逸与内存泄露详解">Go内存逃逸与内存泄露详解</a>
      </li>
    </ul>
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://zhangsiming-blyq.github.io/categories/algorithm/' class="post_tag button button_translucent" title="algorithm">
          ALGORITHM
          <span class="button_tally">15</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/golang/' class="post_tag button button_translucent" title="golang">
          GOLANG
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/shorthand/' class="post_tag button button_translucent" title="shorthand">
          SHORTHAND
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/linux/' class="post_tag button button_translucent" title="linux">
          LINUX
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/python/' class="post_tag button button_translucent" title="python">
          PYTHON
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/algoiithm/' class="post_tag button button_translucent" title="algoiithm">
          ALGOIITHM
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/ansible/' class="post_tag button button_translucent" title="ansible">
          ANSIBLE
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/apigateway/' class="post_tag button button_translucent" title="apigateway">
          APIGATEWAY
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/containerd/' class="post_tag button button_translucent" title="containerd">
          CONTAINERD
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/docker/' class="post_tag button button_translucent" title="docker">
          DOCKER
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/etcd/' class="post_tag button button_translucent" title="etcd">
          ETCD
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/git/' class="post_tag button button_translucent" title="git">
          GIT
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/categories/java/' class="post_tag button button_translucent" title="java">
          JAVA
          <span class="button_tally">1</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://zhangsiming-blyq.github.io/categories/algoiithm/' class=" post_tag button button_translucent" data-position=1 title="algoiithm">ALGOIITHM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/algorithm/' class=" post_tag button button_translucent" data-position=15 title="algorithm">ALGORITHM<span class="button_tally">15</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/apigateway/' class=" post_tag button button_translucent" data-position=1 title="apigateway">APIGATEWAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/containerd/' class=" post_tag button button_translucent" data-position=1 title="containerd">CONTAINERD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/etcd/' class=" post_tag button button_translucent" data-position=1 title="etcd">ETCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/git/' class=" post_tag button button_translucent" data-position=1 title="git">GIT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/golang/' class=" post_tag button button_translucent" data-position=7 title="golang">GOLANG<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/java/' class=" post_tag button button_translucent" data-position=1 title="java">JAVA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=12 title="kubernetes">KUBERNETES<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/linux/' class=" post_tag button button_translucent" data-position=3 title="linux">LINUX<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/prometheus/' class=" post_tag button button_translucent" data-position=1 title="prometheus">PROMETHEUS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/python/' class=" post_tag button button_translucent" data-position=2 title="python">PYTHON<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/shorthand/' class=" post_tag button button_translucent" data-position=4 title="shorthand">SHORTHAND<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/categories/vim/' class=" post_tag button button_translucent" data-position=1 title="vim">VIM<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://zhangsiming-blyq.github.io/tags/%E4%B8%AD%E6%96%87/' class="post_tag button button_translucent" title="中文">
          中文
          <span class="button_tally">33</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/algorithm/' class="post_tag button button_translucent" title="algorithm">
          ALGORITHM
          <span class="button_tally">16</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/english/' class="post_tag button button_translucent" title="english">
          ENGLISH
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/golang/' class="post_tag button button_translucent" title="golang">
          GOLANG
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/shorthand/' class="post_tag button button_translucent" title="shorthand">
          SHORTHAND
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/linux/' class="post_tag button button_translucent" title="linux">
          LINUX
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/etcd/' class="post_tag button button_translucent" title="etcd">
          ETCD
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/python/' class="post_tag button button_translucent" title="python">
          PYTHON
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/about/' class="post_tag button button_translucent" title="about">
          ABOUT
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/ansible/' class="post_tag button button_translucent" title="ansible">
          ANSIBLE
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/apigateway/' class="post_tag button button_translucent" title="apigateway">
          APIGATEWAY
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/apiserver/' class="post_tag button button_translucent" title="apiserver">
          APISERVER
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://zhangsiming-blyq.github.io/tags/bailiyingqi/' class="post_tag button button_translucent" title="bailiyingqi">
          BAILIYINGQI
          <span class="button_tally">1</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://zhangsiming-blyq.github.io/tags/about/' class=" post_tag button button_translucent" data-position=1 title="about">ABOUT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/algorithm/' class=" post_tag button button_translucent" data-position=16 title="algorithm">ALGORITHM<span class="button_tally">16</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/apigateway/' class=" post_tag button button_translucent" data-position=1 title="apigateway">APIGATEWAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/apiserver/' class=" post_tag button button_translucent" data-position=1 title="apiserver">APISERVER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/bailiyingqi/' class=" post_tag button button_translucent" data-position=1 title="bailiyingqi">BAILIYINGQI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/containerd/' class=" post_tag button button_translucent" data-position=1 title="containerd">CONTAINERD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/controller-manager/' class=" post_tag button button_translucent" data-position=1 title="controller-manager">CONTROLLER-MANAGER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/english/' class=" post_tag button button_translucent" data-position=12 title="english">ENGLISH<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/etcd/' class=" post_tag button button_translucent" data-position=2 title="etcd">ETCD<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/git/' class=" post_tag button button_translucent" data-position=1 title="git">GIT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/golang/' class=" post_tag button button_translucent" data-position=7 title="golang">GOLANG<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/java/' class=" post_tag button button_translucent" data-position=1 title="java">JAVA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=13 title="kubernetes">KUBERNETES<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/linux/' class=" post_tag button button_translucent" data-position=3 title="linux">LINUX<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/prometheus/' class=" post_tag button button_translucent" data-position=1 title="prometheus">PROMETHEUS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/python/' class=" post_tag button button_translucent" data-position=2 title="python">PYTHON<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/scheduler/' class=" post_tag button button_translucent" data-position=1 title="scheduler">SCHEDULER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/shorthand/' class=" post_tag button button_translucent" data-position=4 title="shorthand">SHORTHAND<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/vim/' class=" post_tag button button_translucent" data-position=1 title="vim">VIM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://zhangsiming-blyq.github.io/tags/%E4%B8%AD%E6%96%87/' class=" post_tag button button_translucent" data-position=33 title="中文">中文<span class="button_tally">33</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://zhangsiming-blyq.github.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="">
    <p>Copyright&nbsp;<span class="year"></span>&nbsp;. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://zhangsiming-blyq.github.io/en/js/bundle.daf5d72d10b0f1e048706d4cb8d79d1ec41c3b5edcd83acfaa4df80252afff936252c1fa7804d8dcdb500eaf0f7d5adbb79cfe886cf7068f12f58cdebc05e1c3.js" integrity="sha512-2vXXLRCw8eBIcG1MuNedHsQcO17c2DrPqk34AlKv/5NiUsH6eATY3NtQDq8PfVrbt5z&#43;iGz3Bo8S9YzevAXhww==" crossorigin="anonymous"></script>

  <script src="https://zhangsiming-blyq.github.io/js/search.min.9641a8a49c5a7dbd99f372bf456fc577a23b235fd157ee614ce2dab96b2e0f3687d5cc408d875f32e94405a2ccbca5c8bc43491cfce32471b72aa63e5315018d.js"></script>

  </body>
</html>
