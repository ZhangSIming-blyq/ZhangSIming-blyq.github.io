<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>client-go watchæ¥å£éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨é€€å‡ºæ€ä¹ˆåŠï¼Ÿ | ç™¾é‡Œè‹±éª</title>
    <meta property="og:title" content="client-go watchæ¥å£éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨é€€å‡ºæ€ä¹ˆåŠï¼Ÿ - ç™¾é‡Œè‹±éª">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2022-05-28T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2022-05-28T00:00:00&#43;08:00'>
        
    <meta name="Keywords" content="ç™¾é‡Œè‹±éª,BaileysRock,kubernetes,golang,python,shell,linux,sre,è½¯ä»¶æ¶æ„,blog">
    <meta name="description" content="client-go watchæ¥å£éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨é€€å‡ºæ€ä¹ˆåŠï¼Ÿ">
        <meta name="author" content="BaileysRock">
        
    <meta property="og:url" content="https://zhangsiming-blyq.github.io/post/retrywatcher/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangsiming-blyq.github.io/">
                        ç™¾é‡Œè‹±éª
                    </a>
                
                <p class="description">ä¸“æ³¨äºäº‘åŸç”Ÿã€kubernetesã€golangã€pythonã€linuxã€sreä¸è‡ªåŠ¨åŒ–è¿ç»´ã€è½¯ä»¶æ¶æ„ç­‰</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://zhangsiming-blyq.github.io/">é¦–é¡µ</a>
                    
                    <a  href="https://zhangsiming-blyq.github.io/archives/" title="å½’æ¡£">å½’æ¡£</a>
                    
                    <a  href="https://zhangsiming-blyq.github.io/about/" title="å…³äº">å…³äº</a>
                    
                    <a  href="https://zhangsiming-blyq.github.io/is404/" title="ç‚¹æˆ‘å±•ç¤º404">ç‚¹æˆ‘å±•ç¤º404</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ä½¿ç”¨client-go-watchæ¥å£">ä½¿ç”¨client-go watchæ¥å£</a>
      <ul>
        <li><a href="#1-å¦‚ä½•watch">1. å¦‚ä½•watch</a></li>
      </ul>
    </li>
    <li><a href="#å¼‚å¸¸watchæ¥å£è‡ªåŠ¨æ–­å¼€">å¼‚å¸¸ï¼šwatchæ¥å£è‡ªåŠ¨æ–­å¼€</a>
      <ul>
        <li><a href="#1-ç°è±¡">1. ç°è±¡</a></li>
        <li><a href="#2-æ’æŸ¥">2. æ’æŸ¥</a></li>
        <li><a href="#3-åŸå› ">3. åŸå› </a></li>
      </ul>
    </li>
    <li><a href="#è§£å†³åŠæ³•1forinfor">è§£å†³åŠæ³•(1)ï¼šforinfor</a></li>
    <li><a href="#è§£å†³åŠæ³•2retrywatcher">è§£å†³åŠæ³•(2)ï¼šretrywatcher</a></li>
    <li><a href="#ä¸ªäººç‰ˆretrywatcherä»£ç å®ç°">ä¸ªäººç‰ˆRetryWatcherä»£ç å®ç°ï¼š</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">client-go watchæ¥å£éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨é€€å‡ºæ€ä¹ˆåŠï¼Ÿ</h1>
        </header>
        <date class="post-meta meta-date">
            2022å¹´5æœˆ28æ—¥
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category">
                <a href='/categories/golang' target="_blank">golang</a>
            </span>
            
            <span class="meta-category">
                <a href='/categories/kubernetes' target="_blank">kubernetes</a>
            </span>
            
        </div>
        
        
        
        <div class="post-content">
            <blockquote>
<p>åœ¨ä½¿ç”¨client-goçš„watchæ¥å£æ—¶å€™ç¢°åˆ°å¼‚å¸¸é€€å‡ºé—®é¢˜ï¼ŒæŸ¥äº†ä¸€ä¸‹googleæ²¡æœ‰å¤šå°‘ä¿¡æ¯ï¼Œäºæ˜¯æ‰’äº†ä¸€ä¸‹ä»£ç ï¼ŒæŠŠè‡ªå·±è¸©çš„å‘è®°å½•ä¸‹æ¥æ–¹ä¾¿ä»¥åè‡ªæŸ¥è‡ªçº ã€‚</p>
</blockquote>
<h2 id="ä½¿ç”¨client-go-watchæ¥å£">ä½¿ç”¨client-go watchæ¥å£</h2>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h3 id="1-å¦‚ä½•watch">1. å¦‚ä½•watch</h3>
<p>ç”±äºkubernetesæ•´åˆäº†etcdçš„watchåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡watchæ“ä½œå»å»ºç«‹ä¸€ä¸ªé•¿è¿æ¥ï¼Œä¸æ–­çš„æ¥æ”¶æ•°æ®ï¼›è¿™ç§æ–¹å¼è¦ä¼˜äºæ™®é€šçš„åå¤è½®è¯¢è¯·æ±‚ï¼Œé™ä½serverç«¯çš„å‹åŠ›;</p>
<p>ä½¿ç”¨client-goè°ƒç”¨å¯¹åº”å¯¹è±¡çš„Watch()æ–¹æ³•ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªwatch.Eventå¯¹è±¡ï¼Œå¯ä»¥å¯¹å…¶ä½¿ç”¨ResultChan()æ¥å—watchåˆ°çš„å¯¹è±¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">pod, err <span style="color:#666">:=</span> mycluster.Clusterclientset.<span style="color:#06287e">CoreV1</span>().<span style="color:#06287e">Pods</span>(appNamespace).<span style="color:#06287e">Watch</span>(context.<span style="color:#06287e">TODO</span>(), metav1.ListOptions{LabelSelector: label})
<span style="color:#007020;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">nil</span> {
    log.<span style="color:#06287e">Error</span>(err)
}
<span style="color:#666">...</span>
event, ok <span style="color:#666">:=</span> <span style="color:#666">&lt;-</span>pod.<span style="color:#06287e">ResultChan</span>()
<span style="color:#007020;font-weight:bold">if</span> !ok {
    log.<span style="color:#06287e">Error</span>(err)
}
</code></pre></div><h2 id="å¼‚å¸¸watchæ¥å£è‡ªåŠ¨æ–­å¼€">å¼‚å¸¸ï¼šwatchæ¥å£è‡ªåŠ¨æ–­å¼€</h2>
<h3 id="1-ç°è±¡">1. ç°è±¡</h3>
<p>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œwatchæ“ä½œæŒç»­ä¸€æ®µæ—¶é—´å°±ä¼šè‡ªåŠ¨æ–­å¼€</p>
<h3 id="2-æ’æŸ¥">2. æ’æŸ¥</h3>
<p>æˆ‘ä»¬è¿›å…¥watchåŒ…é‡Œé¢æ‰¾åˆ°streamwatcher.goï¼Œå…¶ä¸­èŠ‚é€‰äº†ä¸€äº›é‡è¦ç‰‡æ®µï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">type</span> StreamWatcher <span style="color:#007020;font-weight:bold">struct</span> {
	sync.Mutex
	source   Decoder
	reporter Reporter
	result   <span style="color:#007020;font-weight:bold">chan</span> Event
	stopped  <span style="color:#902000">bool</span>
}
<span style="color:#666">...</span>
<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">NewStreamWatcher</span>(d Decoder, r Reporter) <span style="color:#666">*</span>StreamWatcher {
	sw <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>StreamWatcher{
		source:   d,
		reporter: r,
		<span style="color:#60a0b0;font-style:italic">// It&#39;s easy for a consumer to add buffering via an extra
</span><span style="color:#60a0b0;font-style:italic"></span>		<span style="color:#60a0b0;font-style:italic">// goroutine/channel, but impossible for them to remove it,
</span><span style="color:#60a0b0;font-style:italic"></span>		<span style="color:#60a0b0;font-style:italic">// so nonbuffered is better.
</span><span style="color:#60a0b0;font-style:italic"></span>		result: <span style="color:#007020">make</span>(<span style="color:#007020;font-weight:bold">chan</span> Event),
	}
	<span style="color:#007020;font-weight:bold">go</span> sw.<span style="color:#06287e">receive</span>()
	<span style="color:#007020;font-weight:bold">return</span> sw
}
<span style="color:#666">...</span>
<span style="color:#007020;font-weight:bold">func</span> (sw <span style="color:#666">*</span>StreamWatcher) <span style="color:#06287e">receive</span>() {
	<span style="color:#007020;font-weight:bold">defer</span> <span style="color:#007020">close</span>(sw.result)
	<span style="color:#007020;font-weight:bold">defer</span> sw.<span style="color:#06287e">Stop</span>()
	<span style="color:#007020;font-weight:bold">defer</span> utilruntime.<span style="color:#06287e">HandleCrash</span>()
	<span style="color:#007020;font-weight:bold">for</span> {
		action, obj, err <span style="color:#666">:=</span> sw.source.<span style="color:#06287e">Decode</span>()
		<span style="color:#007020;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">nil</span> {
			<span style="color:#60a0b0;font-style:italic">// Ignore expected error.
</span><span style="color:#60a0b0;font-style:italic"></span>			<span style="color:#007020;font-weight:bold">if</span> sw.<span style="color:#06287e">stopping</span>() {
				<span style="color:#007020;font-weight:bold">return</span>
			}
			<span style="color:#007020;font-weight:bold">switch</span> err {
			<span style="color:#007020;font-weight:bold">case</span> io.EOF:
				<span style="color:#60a0b0;font-style:italic">// watch closed normally
</span><span style="color:#60a0b0;font-style:italic"></span>			<span style="color:#007020;font-weight:bold">case</span> io.ErrUnexpectedEOF:
				klog.<span style="color:#06287e">V</span>(<span style="color:#40a070">1</span>).<span style="color:#06287e">Infof</span>(<span style="color:#4070a0">&#34;Unexpected EOF during watch stream event decoding: %v&#34;</span>, err)
			<span style="color:#007020;font-weight:bold">default</span>:
				<span style="color:#007020;font-weight:bold">if</span> net.<span style="color:#06287e">IsProbableEOF</span>(err) <span style="color:#666">||</span> net.<span style="color:#06287e">IsTimeout</span>(err) {
					klog.<span style="color:#06287e">V</span>(<span style="color:#40a070">5</span>).<span style="color:#06287e">Infof</span>(<span style="color:#4070a0">&#34;Unable to decode an event from the watch stream: %v&#34;</span>, err)
				} <span style="color:#007020;font-weight:bold">else</span> {
					sw.result <span style="color:#666">&lt;-</span> Event{
						Type:   Error,
						Object: sw.reporter.<span style="color:#06287e">AsObject</span>(fmt.<span style="color:#06287e">Errorf</span>(<span style="color:#4070a0">&#34;unable to decode an event from the watch stream: %v&#34;</span>, err)),
					}
				}
			}
			<span style="color:#007020;font-weight:bold">return</span>
		}
		sw.result <span style="color:#666">&lt;-</span> Event{
			Type:   action,
			Object: obj,
		}
	}
}
</code></pre></div><h3 id="3-åŸå› ">3. åŸå› </h3>
<p>ç»“åˆä»£ç çœ‹ä¸€ä¸‹ï¼ŒStreamWatcherå®ç°äº†Watch()æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸Šè¿°è°ƒç”¨ResultChan()çš„æ—¶å€™ï¼Œå®é™…ä¸Šè¿”å›çš„æ˜¯è¿™é‡Œçš„sw.result;</p>
<p>å†å¾€ä¸‹çœ‹æ–°å»ºStreamWatcherçš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªâ€go sw.receive()â€, ä¹Ÿå°±æ˜¯å‡ ä¹åœ¨æ–°å»ºå¯¹è±¡çš„åŒæ­¥å°±å¼€å§‹æ¥å—å¤„ç†æ•°æ®äº†ï¼Œæœ€åçœ‹åˆ°swçš„receive()æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¤„ç†æ•°æ®çš„æ—¶å€™(sw.source.Decode()), å¦‚æœerrä¸ä¸ºnil, ä¼šswitché›†ä¸­erroræƒ…å†µï¼Œ<strong>æœ€åä¼šç›´æ¥returnï¼Œç„¶ådefer sw.Stop()ï¼›</strong></p>
<p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœæ¥å—æ•°æ®è§£ç çš„æ—¶å€™(sw.source.Decode()), å¦‚æœè§£ç å¤±è´¥ï¼Œé‚£ä¹ˆStreamWatcherå°±è¢«å…³é—­äº†ï¼Œé‚£è‡ªç„¶æ•°æ®é€šé“ä¹Ÿå°±å…³é—­äº†ï¼Œé€ æˆâ€watchä¸€æ®µæ—¶é—´ä¹‹åè‡ªåŠ¨å…³é—­çš„ç°è±¡â€ã€‚</p>
<h2 id="è§£å†³åŠæ³•1forinfor">è§£å†³åŠæ³•(1)ï¼šforinfor</h2>
<p>é‚£ä¹ˆæ—¢ç„¶æ˜¯è¿™ç§æƒ…å†µä¼šå¯¼è‡´watchæ–­å¼€ï¼Œé‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯æš´åŠ›æ¢å¤è¿™ä¸ªStreamWatcherï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">for</span> {
	pod, err <span style="color:#666">:=</span> mycluster.Clusterclientset.<span style="color:#06287e">CoreV1</span>().<span style="color:#06287e">Pods</span>(appNamespace).<span style="color:#06287e">Watch</span>(context.<span style="color:#06287e">TODO</span>(), metav1.ListOptions{LabelSelector: label})
	<span style="color:#007020;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">nil</span> {
		log.<span style="color:#06287e">Error</span>(err)
	}
loopier:
	<span style="color:#007020;font-weight:bold">for</span> {
		event, ok <span style="color:#666">:=</span> <span style="color:#666">&lt;-</span>pod.<span style="color:#06287e">ResultChan</span>()
		<span style="color:#007020;font-weight:bold">if</span> !ok {
			time.<span style="color:#06287e">Sleep</span>(time.Second <span style="color:#666">*</span> <span style="color:#40a070">5</span>)
			log.<span style="color:#06287e">Info</span>(<span style="color:#4070a0">&#34;Restarting watcher...&#34;</span>)
			<span style="color:#007020;font-weight:bold">break</span> loopier
		}
		<span style="color:#60a0b0;font-style:italic">// your process logic
</span><span style="color:#60a0b0;font-style:italic"></span>	}
}
</code></pre></div><p>æˆ‘ä»¬å®šä¹‰ä¸€å±‚foråµŒå¥—ï¼Œå› ä¸ºåœ¨ä¸Šè¿°é€€å‡ºçš„æ—¶å€™ä¼šå…ˆdefer close(sw.result)ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥å—æ•°æ®çš„é€šé“ä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç é‡Œçš„pod.ResultChan()å°±ä¼šå…³é—­ï¼Œç„¶åæˆ‘ä»¬åŠ ä¸€ä¸ªé”™è¯¯å¤„ç†ï¼Œ<strong>ç­‰å¾…5sä¹‹åï¼Œbreakæ‰è¿™ä¸ªloopierå¾ªç¯ï¼Œè®©å¤–å±‚çš„forå¾ªç¯ç»§ç»­æ–°å»ºStreamWatcherç»§ç»­ç›‘å¬æ•°æ®</strong>ã€‚ä»¥æ­¤è¾¾åˆ°æŒç»­ç›‘å¬çš„æ•ˆæœï¼Œå¥½å¤„æ˜¯å®ç°ç®€å•ï¼Œåå¤„æ˜¯ç¼ºå°‘é”™è¯¯åˆ¤æ–­ï¼Œä¸èƒ½é’ˆå¯¹é”™è¯¯ç±»å‹åˆ†åˆ«å¤„ç†ï¼Œå¯¹äºä¸€ç›´å‡ºé”™çš„åœºæ™¯ä¹Ÿåªæ˜¯æ— è„‘é‡å¯ã€‚</p>
<h2 id="è§£å†³åŠæ³•2retrywatcher">è§£å†³åŠæ³•(2)ï¼šretrywatcher</h2>
<p>åœ¨å®˜æ–¹ä»£ç ä¸‹client-go/tools/watch/retrywatcher.goä¸­å…¶å®å®˜æ–¹ç»™äº†ä¸€ä¸ªæ ‡å‡†è§£æ³•ï¼Œç”¨äºè§£å†³watchå¼‚å¸¸é€€å‡ºçš„é—®é¢˜ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹è¿™ç§å®ç°æ–¹å¼ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">type</span> RetryWatcher <span style="color:#007020;font-weight:bold">struct</span> {
	lastResourceVersion <span style="color:#902000">string</span>
	watcherClient       cache.Watcher
	resultChan          <span style="color:#007020;font-weight:bold">chan</span> watch.Event
	stopChan            <span style="color:#007020;font-weight:bold">chan</span> <span style="color:#007020;font-weight:bold">struct</span>{}
	doneChan            <span style="color:#007020;font-weight:bold">chan</span> <span style="color:#007020;font-weight:bold">struct</span>{}
	minRestartDelay     time.Duration
}
<span style="color:#666">...</span>
<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">newRetryWatcher</span>(initialResourceVersion <span style="color:#902000">string</span>, watcherClient cache.Watcher, minRestartDelay time.Duration) (<span style="color:#666">*</span>RetryWatcher, <span style="color:#902000">error</span>) {
	<span style="color:#007020;font-weight:bold">switch</span> initialResourceVersion {
	<span style="color:#007020;font-weight:bold">case</span> <span style="color:#4070a0">&#34;&#34;</span>, <span style="color:#4070a0">&#34;0&#34;</span>:
		<span style="color:#60a0b0;font-style:italic">// TODO: revisit this if we ever get WATCH v2 where it means start &#34;now&#34;
</span><span style="color:#60a0b0;font-style:italic"></span>		<span style="color:#60a0b0;font-style:italic">//       without doing the synthetic list of objects at the beginning (see #74022)
</span><span style="color:#60a0b0;font-style:italic"></span>		<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">nil</span>, fmt.<span style="color:#06287e">Errorf</span>(<span style="color:#4070a0">&#34;initial RV %q is not supported due to issues with underlying WATCH&#34;</span>, initialResourceVersion)
	<span style="color:#007020;font-weight:bold">default</span>:
		<span style="color:#007020;font-weight:bold">break</span>
	}

	rw <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>RetryWatcher{
		lastResourceVersion: initialResourceVersion,
		watcherClient:       watcherClient,
		stopChan:            <span style="color:#007020">make</span>(<span style="color:#007020;font-weight:bold">chan</span> <span style="color:#007020;font-weight:bold">struct</span>{}),
		doneChan:            <span style="color:#007020">make</span>(<span style="color:#007020;font-weight:bold">chan</span> <span style="color:#007020;font-weight:bold">struct</span>{}),
		resultChan:          <span style="color:#007020">make</span>(<span style="color:#007020;font-weight:bold">chan</span> watch.Event, <span style="color:#40a070">0</span>),
		minRestartDelay:     minRestartDelay,
	}

	<span style="color:#007020;font-weight:bold">go</span> rw.<span style="color:#06287e">receive</span>()
	<span style="color:#007020;font-weight:bold">return</span> rw, <span style="color:#007020;font-weight:bold">nil</span>
}
</code></pre></div><p>å’Œæ™®é€šçš„StreamWatcherå¾ˆç±»ä¼¼ï¼Œè¿™é‡Œé¢RetryWatcherå¤šäº†ä¸€äº›ç»“æ„ä½“å­—æ®µï¼›lastResourceVersionã€minRestartDelayç”¨äºå‡ºé”™ä¹‹åé‡å¯Watcherçš„RVä¿å­˜ï¼Œä»¥åŠé‡è¯•æ—¶é—´ï¼›ä¼ å…¥initialResourceVersionå’ŒwatcherClient(cache.Watcher)å³å¯åˆ›å»ºä¸€ä¸ªRetryWatcher;</p>
<p>åŒç†ï¼ŒRetryWatcherä¹Ÿæ˜¯åœ¨åˆ›å»ºå¯¹è±¡çš„åŒæ—¶å°±å¼€å§‹go rw.receive()æ¥å—æ•°æ®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">func</span> (rw <span style="color:#666">*</span>RetryWatcher) <span style="color:#06287e">receive</span>() {
	<span style="color:#007020;font-weight:bold">defer</span> <span style="color:#007020">close</span>(rw.doneChan)
	<span style="color:#007020;font-weight:bold">defer</span> <span style="color:#007020">close</span>(rw.resultChan)

	klog.<span style="color:#06287e">V</span>(<span style="color:#40a070">4</span>).<span style="color:#06287e">Info</span>(<span style="color:#4070a0">&#34;Starting RetryWatcher.&#34;</span>)
	<span style="color:#007020;font-weight:bold">defer</span> klog.<span style="color:#06287e">V</span>(<span style="color:#40a070">4</span>).<span style="color:#06287e">Info</span>(<span style="color:#4070a0">&#34;Stopping RetryWatcher.&#34;</span>)

	ctx, cancel <span style="color:#666">:=</span> context.<span style="color:#06287e">WithCancel</span>(context.<span style="color:#06287e">Background</span>())
	<span style="color:#007020;font-weight:bold">defer</span> <span style="color:#06287e">cancel</span>()
	<span style="color:#007020;font-weight:bold">go</span> <span style="color:#007020;font-weight:bold">func</span>() {
		<span style="color:#007020;font-weight:bold">select</span> {
		<span style="color:#007020;font-weight:bold">case</span> <span style="color:#666">&lt;-</span>rw.stopChan:
			<span style="color:#06287e">cancel</span>()
			<span style="color:#007020;font-weight:bold">return</span>
		<span style="color:#007020;font-weight:bold">case</span> <span style="color:#666">&lt;-</span>ctx.<span style="color:#06287e">Done</span>():
			<span style="color:#007020;font-weight:bold">return</span>
		}
	}()

	<span style="color:#60a0b0;font-style:italic">// We use non sliding until so we don&#39;t introduce delays on happy path when WATCH call
</span><span style="color:#60a0b0;font-style:italic"></span>	<span style="color:#60a0b0;font-style:italic">// timeouts or gets closed and we need to reestablish it while also avoiding hot loops.
</span><span style="color:#60a0b0;font-style:italic"></span>	wait.<span style="color:#06287e">NonSlidingUntilWithContext</span>(ctx, <span style="color:#007020;font-weight:bold">func</span>(ctx context.Context) {
		done, retryAfter <span style="color:#666">:=</span> rw.<span style="color:#06287e">doReceive</span>()
		<span style="color:#007020;font-weight:bold">if</span> done {
			<span style="color:#06287e">cancel</span>()
			<span style="color:#007020;font-weight:bold">return</span>
		}

		time.<span style="color:#06287e">Sleep</span>(retryAfter)

		klog.<span style="color:#06287e">V</span>(<span style="color:#40a070">4</span>).<span style="color:#06287e">Infof</span>(<span style="color:#4070a0">&#34;Restarting RetryWatcher at RV=%q&#34;</span>, rw.lastResourceVersion)
	}, rw.minRestartDelay)
}
<span style="color:#666">...</span>
<span style="color:#007020;font-weight:bold">func</span> (rw <span style="color:#666">*</span>RetryWatcher) <span style="color:#06287e">Stop</span>() {
	<span style="color:#007020">close</span>(rw.stopChan)
}
</code></pre></div><p>ä¸Šé¢ä»£ç çš„receive()å‡½æ•°ä¸­ï¼ŒwaitåŒ…èµ·åˆ°æ ¸å¿ƒé‡è¯•é€»è¾‘ä½œç”¨ï¼Œä»–ä¼šå¾ªç¯æ‰§è¡Œé‡Œé¢çš„å‡½æ•°ï¼Œç›´åˆ°æ”¶åˆ°context Done çš„ä¿¡å·æ‰ä¼šå¾€ä¸‹èµ°ï¼›è€Œä¸Šé¢ä»£ç çš„ctxåªæœ‰ä¸¤ç§æƒ…å†µæ‰ä¼šè¢«å…³é—­ï¼š</p>
<ol>
<li>æœ‰äººè°ƒç”¨äº†RetryWatcherçš„Stop()ï¼›</li>
<li>å¦å¤–å°±æ˜¯rw.doReceive()ä¸­è¿”å›äº†done, ä¹Ÿä¼šç›´æ¥è°ƒç”¨cancel()ç»“æŸwaitéƒ¨åˆ†ã€‚</li>
</ol>
<p><strong>è€Œå¦‚æœæ¥å—çš„doneä¸ºfalseï¼Œåˆ™ä¼šæ­£å¸¸ç­‰å¾…time.Sleep(retryAfter)ä¹‹åï¼Œè¿›è¡Œé‡è¯•ï¼Œå®ç°RetryWatcherï¼</strong></p>
<p>æ¥ä¸‹æ¥å°±çœ‹ä¸‹è¿™ä¸ªrw.doReceive()ï¼Œä¹Ÿå°±æ˜¯RetryWatcherçš„æ¥æ”¶å¤„ç†æ•°æ®éƒ¨åˆ†, åŒæ—¶ä¼šæ ¹æ®errç±»å‹åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">func</span> (rw <span style="color:#666">*</span>RetryWatcher) <span style="color:#06287e">doReceive</span>() (<span style="color:#902000">bool</span>, time.Duration) {
	watcher, err <span style="color:#666">:=</span> rw.watcherClient.<span style="color:#06287e">Watch</span>(metav1.ListOptions{
		ResourceVersion:     rw.lastResourceVersion,
		AllowWatchBookmarks: <span style="color:#007020;font-weight:bold">true</span>,
	})
	<span style="color:#60a0b0;font-style:italic">// We are very unlikely to hit EOF here since we are just establishing the call,
</span><span style="color:#60a0b0;font-style:italic"></span>	<span style="color:#60a0b0;font-style:italic">// but it may happen that the apiserver is just shutting down (e.g. being restarted)
</span><span style="color:#60a0b0;font-style:italic"></span>	<span style="color:#60a0b0;font-style:italic">// This is consistent with how it is handled for informers
</span><span style="color:#60a0b0;font-style:italic"></span>	<span style="color:#007020;font-weight:bold">switch</span> err {
<span style="color:#666">...</span>
<span style="color:#60a0b0;font-style:italic">// çœç•¥watchçš„ä¸€äº›é”™è¯¯å¤„ç†ï¼Œéƒ½ä¼šè¿”å›falseï¼Œä¹Ÿå°±æ˜¯ç»§ç»­waité‡è¯•
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">...</span>
	}

	<span style="color:#007020;font-weight:bold">if</span> watcher <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">nil</span> {
		klog.<span style="color:#06287e">Error</span>(<span style="color:#4070a0">&#34;Watch returned nil watcher&#34;</span>)
		<span style="color:#60a0b0;font-style:italic">// Retry
</span><span style="color:#60a0b0;font-style:italic"></span>		<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">false</span>, <span style="color:#40a070">0</span>
	}

	ch <span style="color:#666">:=</span> watcher.<span style="color:#06287e">ResultChan</span>()
	<span style="color:#007020;font-weight:bold">defer</span> watcher.<span style="color:#06287e">Stop</span>()

	<span style="color:#007020;font-weight:bold">for</span> {
		<span style="color:#007020;font-weight:bold">select</span> {
		<span style="color:#007020;font-weight:bold">case</span> <span style="color:#666">&lt;-</span>rw.stopChan:
			klog.<span style="color:#06287e">V</span>(<span style="color:#40a070">4</span>).<span style="color:#06287e">Info</span>(<span style="color:#4070a0">&#34;Stopping RetryWatcher.&#34;</span>)
			<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">true</span>, <span style="color:#40a070">0</span>
		<span style="color:#007020;font-weight:bold">case</span> event, ok <span style="color:#666">:=</span> <span style="color:#666">&lt;-</span>ch:
			<span style="color:#007020;font-weight:bold">if</span> !ok {
				klog.<span style="color:#06287e">V</span>(<span style="color:#40a070">4</span>).<span style="color:#06287e">Infof</span>(<span style="color:#4070a0">&#34;Failed to get event! Re-creating the watcher. Last RV: %s&#34;</span>, rw.lastResourceVersion)
				<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">false</span>, <span style="color:#40a070">0</span>
			}

			<span style="color:#60a0b0;font-style:italic">// We need to inspect the event and get ResourceVersion out of it
</span><span style="color:#60a0b0;font-style:italic"></span>			<span style="color:#007020;font-weight:bold">switch</span> event.Type {
			<span style="color:#007020;font-weight:bold">case</span> watch.Added, watch.Modified, watch.Deleted, watch.Bookmark:
				metaObject, ok <span style="color:#666">:=</span> event.Object.(resourceVersionGetter)
				<span style="color:#666">...</span>
				resourceVersion <span style="color:#666">:=</span> metaObject.<span style="color:#06287e">GetResourceVersion</span>()
				<span style="color:#666">...</span>
        <span style="color:#60a0b0;font-style:italic">// All is fine; send the non-bookmark events and update resource version.
</span><span style="color:#60a0b0;font-style:italic"></span>				<span style="color:#007020;font-weight:bold">if</span> event.Type <span style="color:#666">!=</span> watch.Bookmark {
					ok = rw.<span style="color:#06287e">send</span>(event)
					<span style="color:#007020;font-weight:bold">if</span> !ok {
						<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">true</span>, <span style="color:#40a070">0</span>
					}
				}
				rw.lastResourceVersion = resourceVersion

				<span style="color:#007020;font-weight:bold">continue</span>

			<span style="color:#007020;font-weight:bold">case</span> watch.Error:
			<span style="color:#666">...</span>
			}
		}
	}
}
<span style="color:#666">...</span>
<span style="color:#007020;font-weight:bold">func</span> (rw <span style="color:#666">*</span>RetryWatcher) <span style="color:#06287e">send</span>(event watch.Event) <span style="color:#902000">bool</span> {
	<span style="color:#60a0b0;font-style:italic">// Writing to an unbuffered channel is blocking operation
</span><span style="color:#60a0b0;font-style:italic"></span>	<span style="color:#60a0b0;font-style:italic">// and we need to check if stop wasn&#39;t requested while doing so.
</span><span style="color:#60a0b0;font-style:italic"></span>	<span style="color:#007020;font-weight:bold">select</span> {
	<span style="color:#007020;font-weight:bold">case</span> rw.resultChan <span style="color:#666">&lt;-</span> event:
		<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">true</span>
	<span style="color:#007020;font-weight:bold">case</span> <span style="color:#666">&lt;-</span>rw.stopChan:
		<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">false</span>
	}
}
</code></pre></div><p>ä¸Šé¢ä»£ç æˆ‘å·²ç»éå¸¸æ¸…æ™°çš„å±•ç¤ºå‡ºäº†doReceive()çš„å¤„ç†é€»è¾‘ï¼Œç¬¬ä¸€æ­¥ä¼šæŒ‰ç…§rwä¸­å®šä¹‰çš„watcherå¼€å§‹çœŸå®çš„ç›‘å¬å¯¹åº”èµ„æºå¯¹è±¡ï¼Œè¿™é‡Œè¿”å›é”™è¯¯çš„è¯ä¹Ÿä¼šè¿›è¡Œrwçš„é‡è¯•é€»è¾‘ï¼›ç„¶åä¼šè·å–çœŸå®çš„watcher.ResultChan()ä¹Ÿå°±æ˜¯å¯ä»¥è·å–åˆ°çœŸå®å¯¹è±¡çš„é€šé“ï¼Œ<strong>å¥—ç”¨for selectæ¨¡å¼ï¼Œå¾ªç¯æ¥å—æ•°æ®ï¼Œå¦‚æœæ•°æ®ä¸€ç›´æ˜¯æ­£å¸¸çš„ï¼Œé‚£ä¹ˆä¼šé€šè¿‡rw.send(event)å‘é€ç»™rw.ResultChanï¼Œç„¶åè®°å½•ä¿å­˜rw.lastResourceVersionç„¶åç»§ç»­æ¥æ”¶ï¼Œå®ç°watchçš„åŠŸèƒ½</strong>ï¼›</p>
<p>è¿™é‡Œå¤šè¯´ä¸€å¥ï¼Œç”±äºrw.lastResourceVersionæ˜¯ä¿å­˜åœ¨rwçš„ï¼Œä¹Ÿå°±æ˜¯åŠæ—¶é‡å¯(å¯¹åº”ä¸Šé¢çš„ä»»æ„ä¸€ä¸ªcaseè¿”å›çš„æ˜¯true)ï¼Œä¼šä»rw.lastResourceVersionä¹Ÿå°±æ˜¯æœ€æ–°çš„RVå¼€å§‹ç›‘å¬ï¼Œè¿™æ ·å®ç°æ ¹æ®ç‰¹å®šåŸå› é‡å¯æ•…éšœçš„watcherï¼Œæ¯”è¾ƒåˆç†ï¼Œä¹Ÿå¾ˆå·§å¦™ï¼Œæ˜¯å®˜æ–¹çš„æ ‡å‡†ç­”æ¡ˆã€‚</p>
<h2 id="ä¸ªäººç‰ˆretrywatcherä»£ç å®ç°">ä¸ªäººç‰ˆRetryWatcherä»£ç å®ç°ï¼š</h2>
<p>è¯´äº†é‚£ä¹ˆå¤šï¼Œé‚£ä¹ˆå…·ä½“è¦æ€ä¹ˆä½¿ç”¨è¿™ä¸ªRetryWatcherå‘¢ï¼Ÿæˆ‘ä¸ªäººåšäº†ä¸€ä¸ªå¦¥åæ–¹æ¡ˆå¯ä»¥å‚è€ƒï¼š</p>
<p>è¿˜è®°å¾—RetryWatcherä¸­å®šä¹‰çš„watcherClientç±»å‹å—ï¼Œéœ€è¦æ˜¯cache.Watcherï¼Œç„¶åæˆ‘ä»¬çœ‹client-go/tools/cacheé‡Œé¢å®šä¹‰çš„cache.Watcheræ¥å£ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">type</span> Watcher <span style="color:#007020;font-weight:bold">interface</span> {
	<span style="color:#60a0b0;font-style:italic">// Watch should begin a watch at the specified version.
</span><span style="color:#60a0b0;font-style:italic"></span>	<span style="color:#06287e">Watch</span>(options metav1.ListOptions) (watch.Interface, <span style="color:#902000">error</span>)
}
</code></pre></div><p>ä¹Ÿå°±æ˜¯å®ç°äº†Watch(xxxx)è¿™ä¸ªæ–¹æ³•çš„å°±æ˜¯ç¬¦åˆçš„cache.Watcher; è€Œæœ€å¼€å§‹æˆ‘ä»¬ä»£ç æ­£å¥½æ˜¯é€šè¿‡MyCluster.Clusterclientset.CoreV1().Pods()è¿”å›çš„æ¥å£v1.PodInterfaceä¸­è°ƒç”¨çš„Watch(xxxxx), é‚£ä¹ˆç›´æ¥ç”¨â€œMyCluster.Clusterclientset.CoreV1().Pods()â€æ¥ç”ŸæˆRetryWatcheræ˜¯ä¸æ˜¯å°±è¡Œäº†ï¼</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥å£ç±»å‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">type</span> PodInterface <span style="color:#007020;font-weight:bold">interface</span> {
	<span style="color:#666">...</span>
	<span style="color:#06287e">Watch</span>(ctx context.Context, opts metav1.ListOptions) (watch.Interface, <span style="color:#902000">error</span>)
	<span style="color:#666">...</span>
}
</code></pre></div><p>ç­”æ¡ˆæ˜¯ä¸è¡Œâ€¦ ä¸‹é¢è¿™ä¸ªå¤šäº†ä¸€ä¸ªctxå‚æ•° ğŸ¥¶ï¼Œä½†æ˜¯æˆ‘ä»¬å°±æ˜¯æƒ³ä»Clientsetè¿™é‡Œç”¨æ€ä¹ˆåŠï¼Œè‡ªå·±å®ç°ä¸€ä¸ªç¬¦åˆçš„ç»“æ„å§ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">type</span> PodListWatch <span style="color:#007020;font-weight:bold">struct</span> {
	MyCluster    <span style="color:#666">*</span>initk8s.MyCluster
	AppNamespace <span style="color:#902000">string</span>
}
<span style="color:#60a0b0;font-style:italic">// watchæŒ‡å®šå‘½åç©ºé—´ä¸‹çš„Podä¾‹å­ 
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">func</span> (p PodListWatch) <span style="color:#06287e">Watch</span>(options metav1.ListOptions) (watch.Interface, <span style="color:#902000">error</span>) {
	<span style="color:#007020;font-weight:bold">return</span> p.MyCluster.Clusterclientset.<span style="color:#06287e">CoreV1</span>().<span style="color:#06287e">Pods</span>(p.AppNamespace).<span style="color:#06287e">Watch</span>(context.<span style="color:#06287e">TODO</span>(), options)
}
</code></pre></div><p>è¿™ä¸ªPodListWatchçš„Watch(xxxx)æ–¹æ³•æ­£å¥½æ»¡è¶³cache.Watcher, å•åwatchçš„æ–¹å¼è¿˜æ˜¯æŒ‰ç…§æˆ‘ä»¬åŸå…ˆClientsetçš„ï¼Œç„¶åç”ŸæˆRetryWatcherçš„æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">ResourceWatcher</span>(mycluster <span style="color:#666">*</span>initk8s.MyCluster, appNamespace <span style="color:#902000">string</span>) {
	podWatcher <span style="color:#666">:=</span> PodListWatch{MyCluster: mycluster, AppNamespace: appNamespace}
	<span style="color:#60a0b0;font-style:italic">// generate new retrywatcher, use podRetryWatcher.ResultChan() to keep a chronic watch operation
</span><span style="color:#60a0b0;font-style:italic"></span>	podRetryWatcher, err <span style="color:#666">:=</span> retrywatcher.<span style="color:#06287e">NewRetryWatcher</span>(label, podWatcher)
	<span style="color:#007020;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">nil</span> {
		log.<span style="color:#06287e">Error</span>(err)
	}
FORWATCHER:
	<span style="color:#007020;font-weight:bold">for</span> {
		<span style="color:#007020;font-weight:bold">select</span> {
		<span style="color:#007020;font-weight:bold">case</span> <span style="color:#666">&lt;-</span>podRetryWatcher.<span style="color:#06287e">Done</span>():
			log.<span style="color:#06287e">Info</span>(<span style="color:#4070a0">&#34;Retrywatcher is exiting, please check...&#34;</span>)
			<span style="color:#007020;font-weight:bold">break</span> FORWATCHER
		<span style="color:#007020;font-weight:bold">case</span> event, ok <span style="color:#666">:=</span> <span style="color:#666">&lt;-</span>podRetryWatcher.<span style="color:#06287e">ResultChan</span>():
			<span style="color:#007020;font-weight:bold">if</span> !ok {
				log.<span style="color:#06287e">Warn</span>(<span style="color:#4070a0">&#34;Retrywatcher is not open, please check...&#34;</span>)
				<span style="color:#007020;font-weight:bold">continue</span>
			}
			<span style="color:#666">...</span>
</code></pre></div><blockquote>
<p>ä¸Šè¿°åªæ˜¯ä¸€ç§æ€è·¯æä¾›ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åˆ°ä½¿ç”¨client-goè¿›è¡Œwatchçš„åŒå­¦ï¼›å®˜æ–¹çš„å®ç°RetryWatcherç¡®å®æ›´åŠ åˆç†ï¼Œè¿˜å¯ä»¥è¿›è¡Œæ”¹é€ åŠ å‡ä¸åŒæƒ…å†µæ˜¯å¦é‡è¯•çš„ç­–ç•¥ã€‚å¦å¤–watchæ–¹æ³•æ¯•ç«Ÿæ˜¯ç›´æ¥å’Œkubernetesä¸­çš„apiserveræ²Ÿé€šï¼Œå¦‚æœæƒ³è¦å‡è½»apiserverçš„å‹åŠ›kubernetesæä¾›äº†æ›´åŠ å¸¸ç”¨çš„<strong>informeræœºåˆ¶</strong>(sharedinformerä¹Ÿæ˜¯ä¼—å¤šcontrollerä½¿ç”¨çš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æˆ‘è®¤ä¸ºkubernetesæœ€æ ¸å¿ƒçš„åŠŸèƒ½)ï¼Œè‡³äºä½¿ç”¨informerå°±åˆæœ‰å¾ˆå¤šè¦è¯´çš„äº†ï¼Œä»¥åæœ‰æ—¶é—´å¯èƒ½ä¼šæ›´æ–°~</p>
</blockquote>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/monitor-control-plane/">prometheus ç›‘æµ‹ kubernetes æ§åˆ¶å¹³é¢</a></li>
        
        <li><a href="/post/containerd/">æµ…è°ˆ containerd</a></li>
        
        <li><a href="/post/python-yield/">python yieldè¯¦è§£</a></li>
        
        <li><a href="/post/indexfund/">æŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—æ‘˜è®°</a></li>
        
        <li><a href="/about/">å…³äºæˆ‘</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/golang' target="_blank">golang</a></li>
                
                <li><a href='/tags/kubernetes' target="_blank">kubernetes</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "ZhangSIming-blyq/blogcommit"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://zhangsiming-blyq.github.io/">ç™¾é‡Œè‹±éª By BaileysRock</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">é£é›ªæ— æƒ…</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>





                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangsiming-blyq.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangsiming-blyq.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">æœ€è¿‘æ–‡ç« </h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/ansible-playbook/" title="ansible-playbook è¯¦è§£" target="_blank">ansible-playbook è¯¦è§£</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/algorithm/4/" title="ã€ç®—æ³•ç³»åˆ—ã€‘çŒ«ç‹—é˜Ÿåˆ—" target="_blank">ã€ç®—æ³•ç³»åˆ—ã€‘çŒ«ç‹—é˜Ÿåˆ—</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/algorithm/3/" title="ã€ç®—æ³•ç³»åˆ—ã€‘å¦‚ä½•ä»…ç”¨é€’å½’å‡½æ•°å’Œæ ˆæ“ä½œé€†åºä¸€ä¸ªæ ˆ" target="_blank">ã€ç®—æ³•ç³»åˆ—ã€‘å¦‚ä½•ä»…ç”¨é€’å½’å‡½æ•°å’Œæ ˆæ“ä½œé€†åºä¸€ä¸ªæ ˆ</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/algorithm/2/" title="ã€ç®—æ³•ç³»åˆ—ã€‘ç”±ä¸¤ä¸ªæ ˆç»„æˆçš„é˜Ÿåˆ—" target="_blank">ã€ç®—æ³•ç³»åˆ—ã€‘ç”±ä¸¤ä¸ªæ ˆç»„æˆçš„é˜Ÿåˆ—</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/algorithm/1/" title="ã€ç®—æ³•ç³»åˆ—ã€‘è®¾è®¡ä¸€ä¸ªæœ‰getMinåŠŸèƒ½çš„æ ˆ" target="_blank">ã€ç®—æ³•ç³»åˆ—ã€‘è®¾è®¡ä¸€ä¸ªæœ‰getMinåŠŸèƒ½çš„æ ˆ</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/retrywatcher/" title="client-go watchæ¥å£éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨é€€å‡ºæ€ä¹ˆåŠï¼Ÿ" target="_blank">client-go watchæ¥å£éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨é€€å‡ºæ€ä¹ˆåŠï¼Ÿ</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/python-yield/" title="python yieldè¯¦è§£" target="_blank">python yieldè¯¦è§£</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/monitor-control-plane/" title="prometheus ç›‘æµ‹ kubernetes æ§åˆ¶å¹³é¢" target="_blank">prometheus ç›‘æµ‹ kubernetes æ§åˆ¶å¹³é¢</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/indexfund/" title="æŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—æ‘˜è®°" target="_blank">æŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—æ‘˜è®°</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/containerd/" title="æµ…è°ˆ containerd" target="_blank">æµ…è°ˆ containerd</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>åˆ†ç±»</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/algorithm/">algorithm (4)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/ansible/">ansible (1)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/containerd/">containerd (1)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/docker/">docker (1)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/finance/">finance (1)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/golang/">golang (1)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/kubernetes/">kubernetes (2)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/linux/">linux (1)</a></li>
    
    <li><a href="https://zhangsiming-blyq.github.io/categories/python/">python (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>æ ‡ç­¾</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangsiming-blyq.github.io/tags/BaileysRock/">BaileysRock</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/about/">about</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/algorithm/">algorithm</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/ansible/">ansible</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/apiserver/">apiserver</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/containerd/">containerd</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/controller-manager/">controller-manager</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/etcd/">etcd</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/finance/">finance</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/fund/">fund</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/golang/">golang</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/kubernetes/">kubernetes</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/linux/">linux</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/python/">python</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/scheduler/">scheduler</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">å…¶å®ƒ</h3>
        <ul class="widget-list">
            <li><a href="https://zhangsiming-blyq.github.io/index.xml">æ–‡ç«  RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>