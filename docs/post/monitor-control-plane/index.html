<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>prometheus 监测 kubernetes 控制平面 | 百里英骐</title>
    <meta property="og:title" content="prometheus 监测 kubernetes 控制平面 - 百里英骐">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2022-04-11T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2022-04-11T00:00:00&#43;08:00'>
        
    <meta name="Keywords" content="百里英骐,BaileysRock,kubernetes,golang,python,shell,linux,sre,软件架构,blog">
    <meta name="description" content="prometheus 监测 kubernetes 控制平面">
        <meta name="author" content="BaileysRock">
        
    <meta property="og:url" content="https://zhangsiming-blyq.github.io/post/monitor-control-plane/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangsiming-blyq.github.io/">
                        百里英骐
                    </a>
                
                <p class="description">专注于云原生、kubernetes、golang、python、linux、sre与自动化运维、软件架构等</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://zhangsiming-blyq.github.io/">首页</a>
                    
                    <a  href="https://zhangsiming-blyq.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://zhangsiming-blyq.github.io/about/" title="关于">关于</a>
                    
                    <a  href="https://zhangsiming-blyq.github.io/is404/" title="点我展示404">点我展示404</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">prometheus 监测 kubernetes 控制平面</h1>
        </header>
        <date class="post-meta meta-date">
            2022年4月11日
        </date>
        
        
        
        <div class="post-content">
            <blockquote>
<p>对于 kubernetes 集群的控制平面组件，监控是必要的, 他可以帮助我们获取到集群的整体负载压力，并在核心组件出问题的时候配合告警让管理员及时发现问题，及时处理，更稳定的保证集群的生命周期。</p>
</blockquote>
<h3 id="一prometheus-如何自动发现-kubernetes-metrics-接口">一、Prometheus 如何自动发现 Kubernetes Metrics 接口?</h3>
<blockquote>
<p>prometheus 收集 kubernetes 集群中的指标有两种方式，一种是使用 crd(servicemonitors.monitoring.coreos.com)的方式，主要通过标签匹配；另一种是通过 scrape_config，支持根据配置好的&quot;relabel_configs&quot;中的具体目标, 进行不断拉取(拉取间隔为&quot;scrape_interval&rdquo;)</p>
</blockquote>
<ul>
<li>配置权限：</li>
</ul>
<blockquote>
<p>k8s 中 RBAC 支持授权资源对象的权限，比如可以 get、list、watch 集群中的 pod，还支持直接赋予对象访问 api 路径的权限，比如获取/healthz, /api 等, 官方对于 non_resource_urls 的解释如下：</p>
</blockquote>
<p><strong>non_resource_urls</strong> - (Optional) NonResourceURLs is a set of partial urls that a user should have access to. *s are allowed, but only as the full, final step in the path Since non-resource URLs are not namespaced, this field is only applicable for ClusterRoles referenced from a ClusterRoleBinding. Rules can either apply to API resources (such as &ldquo;pods&rdquo; or &ldquo;secrets&rdquo;) or non-resource URL paths (such as &ldquo;/api&rdquo;), but not both.</p>
<blockquote>
<p>既然 prometheus 要主动抓取指标，就必须对他使用的 serviceaccount 提前进行 RBAC 授权：</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># clusterrole.yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: monitor
rules:
- apiGroups: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span>
  resources:
  - nodes
  - pods
  - endpoints
  - services
  verbs: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span><span style="color:#f92672">]</span>
- nonResourceURLs: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/metrics&#34;</span><span style="color:#f92672">]</span>
  verbs: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;get&#34;</span><span style="color:#f92672">]</span>

<span style="color:#75715e"># clusterrolebinding</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-api-monitor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: monitor
subjects:
- kind: ServiceAccount
  name: prometheus-operator-nx-prometheus
  namespace: monitor
</code></pre></div><ul>
<li>获取 apiserver 自身的 metric 信息：</li>
</ul>
<blockquote>
<p>prometheus 中配置&quot;scrape_config&rdquo;, 或者 prometheus-operator 中配置&quot;additionalScrapeConfigs&rdquo;, 配置获取 default 命名空间下的 kubernetes endpoints</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">- job_name: <span style="color:#e6db74">&#39;kubernetes-apiservers&#39;</span>
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
        - source_labels: <span style="color:#f92672">[</span>__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name<span style="color:#f92672">]</span>
          action: keep
          regex: default;kubernetes;https
</code></pre></div><ul>
<li>获取 controller-manager、scheduler 的 metric 信息：</li>
</ul>
<blockquote>
<p>controller-manager 和 scheduler 因为自身暴露 metric 接口，需要修改对应 manifests 下的静态 pod 文件，添加匹配的 annotations 即可完成抓取：</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># prometheus端配置</span>
kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: <span style="color:#f92672">[</span>__meta_kubernetes_pod_annotation_prometheus_io_scrape<span style="color:#f92672">]</span>
        action: <span style="color:#e6db74">&#34;keep&#34;</span>
        regex: <span style="color:#e6db74">&#34;true&#34;</span>
      - source_labels: <span style="color:#f92672">[</span>__address__, __meta_kubernetes_pod_annotation_prometheus_io_port<span style="color:#f92672">]</span>
        action: replace
        regex: <span style="color:#f92672">([</span>^:<span style="color:#f92672">]</span>+<span style="color:#f92672">)(</span>?::<span style="color:#ae81ff">\d</span>+<span style="color:#f92672">)</span>?;<span style="color:#f92672">(</span><span style="color:#ae81ff">\d</span>+<span style="color:#f92672">)</span>
        replacement: $1:$2
        target_label: __address__
      - source_labels: <span style="color:#f92672">[</span>__meta_kubernetes_pod_annotation_prometheus_io_path<span style="color:#f92672">]</span>
        action: replace
        target_label: __metrics_path__
        regex: <span style="color:#e6db74">&#34;(.+)&#34;</span>
      - action: labelmap
        regex: __meta_kubernetes_pod_label_<span style="color:#f92672">(</span>.+<span style="color:#f92672">)</span>
      - source_labels: <span style="color:#f92672">[</span>__meta_kubernetes_namespace<span style="color:#f92672">]</span>
        action: replace
        target_label: kubernetes_namespace
      - source_labels: <span style="color:#f92672">[</span>__meta_kubernetes_pod_name<span style="color:#f92672">]</span>
        action: replace
        target_label: kubernetes_pod_name

<span style="color:#75715e"># controller-manager配置:</span>
metadata:
  annotations:
    prometheus_io_scrape: <span style="color:#e6db74">&#34;true&#34;</span>
    prometheus.io/port: <span style="color:#e6db74">&#34;10252&#34;</span>

<span style="color:#75715e"># scheduler配置：</span>
metadata:
  annotations:
    prometheus_io_scrape: <span style="color:#e6db74">&#34;true&#34;</span>
    prometheus.io/port: <span style="color:#e6db74">&#34;10251&#34;</span>
</code></pre></div><ul>
<li>获取 etcd 的 metric 信息：</li>
</ul>
<blockquote>
<p>etcd 是跑在物理机上的，所以我们先创建对应的 endpoints 绑定好 service，然后采用 servicemonitor 的方式去匹配获取 etcd 的监控指标：</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># service.yaml</span>
apiVersion: v1
kind: Service
metadata:
  name: etcd-k8s
  namespace: kube-system
  labels:
    k8s-app: etcd
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: port
    port: <span style="color:#ae81ff">2379</span>
    protocol: TCP

<span style="color:#75715e"># endpoint.yaml</span>
apiVersion: v1
kind: Endpoints
metadata:
  name: etcd-k8s
  namespace: kube-system
  labels:
    k8s-app: etcd
subsets:
- addresses:
  - ip: xx.xx.xx.xx
  - ip: xx.xx.xx.xx
  - ip: xx.xx.xx.xx
  ports:
  - name: port
    port: <span style="color:#ae81ff">2379</span>
    protocol: TCP

<span style="color:#75715e"># servicemonitor.yaml(需要配置好相关的证书)</span>
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: etcd-k8s
  namespace: monitor
  labels:
    k8s-app: etcd-k8s
    release: prometheus-operator-nx
spec:
  jobLabel: k8s-app
  endpoints:
  - port: port
    interval: 30s
    scheme: https
    tlsConfig:
      caFile: /ca.pem
      certFile: /server.pem
      keyFile: /server-key.pem
      insecureSkipVerify: true
  selector:
    matchLabels:
      k8s-app: etcd
  namespaceSelector:
    matchNames:
    - kube-system

<span style="color:#75715e"># 最后附上etcd secret的创建方法，将etcd证书挂载进入提供连接使用</span>
apiVersion: v1
data:
  ca.pem: xx
  server.pem: xx
  server-key.pem: xx
kind: Secret
metadata:
  name: etcd-certs
  namespace: monitor
type: Opaque
</code></pre></div><p>
        <img class="mx-auto" alt="image-20210812154811854" src="/assets/monitoring-control-plane/image-20210812154811854.png" />   
    </p>
<h3 id="二我该重点关注哪些-control-plane-指标">二、我该重点关注哪些 control plane 指标？</h3>
<ul>
<li>apiserver: 其中计算延迟可以采用&quot;percentiles&quot;而不是平均数去更好的展示延迟出现情况</li>
</ul>
<blockquote>
<p><strong>apiserver_request_duration_seconds</strong>: 计算读(Non-LIST)请求，读(LIST)请求，写请求的平均处理时间<br>
<strong>apiserver_request_total</strong>: 计算 apiserver 的 QPS、计算读请求、写请求的成功率; 还可以计算请求错误数量以及错误码<br>
<strong>apiserver_current_inflight_requests</strong>: 计算正在处理的读、写请求<br>
<strong>apiserver_dropped_requests_total</strong>: 计算失败的请求</p>
</blockquote>
<ul>
<li>controller-manager:</li>
</ul>
<blockquote>
<p><strong>leader_election_master_status</strong>: 关注是否有 leader<br>
<strong>xxx_depth</strong>: 关注正在调和的控制队列深度</p>
</blockquote>
<ul>
<li>scheduler:</li>
</ul>
<blockquote>
<p><strong>leader_election_master_status</strong>: 关注是否有 leader<br>
<strong>scheduler_schedule_attempts_total</strong>: 帮助查看是否调度器不能正常工作; Number of attempts to schedule pods, by the result. &lsquo;unschedulable&rsquo; means a pod could not be scheduled, while &lsquo;error&rsquo; means an internal scheduler problem<br>
<strong>scheduler_e2e_scheduling_duration_seconds_sum</strong>: scheduler 调度延迟(参数弃用)<br>
<strong>rest_client_requests_total</strong>: client 请求次数(次重要); Number of HTTP requests, partitioned by status code, method, and host</p>
</blockquote>
<ul>
<li>etcd:</li>
</ul>
<blockquote>
<p><strong>etcd_server_has_leader</strong>: etcd 是否有 leader<br>
<strong>etcd_server_leader_changes_seen_total</strong>: etcd leader 切换的次数，如果太频繁可能是一些连接不稳定现象或者 etcd 集群负载过大<br>
<strong>etcd_server_proposals_failed_total</strong>: 一个提议请求是需要完整走过 raft protocol 的，这个指标帮助我们提供请求出错次数，大多数情况是 etcd 选举 leader 失败或者集群缺乏选举的候选人<br>
<strong>etcd_disk_wal_fsync_duration_seconds_sum/etcd_disk_backend_commit_duration_seconds_sum</strong>: etcd 磁盘存储了 kubernetes 的所有重要信息，如果磁盘同步有很大延迟会影响 kubernetes 集群的操作, 此指标提供了 etcd 磁盘同步的平均延迟<br>
<strong>etcd_debugging_mvcc_db_total_size_in_bytes</strong>: etcd 各节点容量<br>
<strong>etcd_network_peer_sent_bytes_total/etcd_network_peer_received_bytes_total</strong>: 可以计算 etcd 节点的发送/接收数据速率<br>
<strong>grpc_server_started_total</strong>: 可以用于计算 etcd 各个方法的调用速率</p>
</blockquote>
<p>
        <img class="mx-auto" alt="image-20210813142808094" src="/assets/monitoring-control-plane/image-20210813142808094.png" />   
    </p>
<p>
        <img class="mx-auto" alt="image-20210813142837199" src="/assets/monitoring-control-plane/image-20210813142837199.png" />   
    </p>
<p>
        <img class="mx-auto" alt="image-20210813142859968" src="/assets/monitoring-control-plane/image-20210813142859968.png" />   
    </p>
<blockquote>
<p>最后采用的 kubernetes 维护界面由：apiserver 专用仪表盘、etcd 仪表盘、综合控制平面仪表盘和证书监控组成；并且在维护使用过程中根据不同参数，不断调整, 够用就行。</p>
</blockquote>
<h4 id="参考链接">参考链接:</h4>
<p><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/cluster_role">https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/cluster_role</a><br>
<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a><br>
<a href="https://www.datadoghq.com/blog/kubernetes-control-plane-monitoring/">https://www.datadoghq.com/blog/kubernetes-control-plane-monitoring/</a><br>
<a href="https://sysdig.com/blog/monitor-kubernetes-api-server/">https://sysdig.com/blog/monitor-kubernetes-api-server/</a><br>
<a href="https://sysdig.com/blog/monitor-etcd/">https://sysdig.com/blog/monitor-etcd/</a></p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/containerd/">浅谈 containerd</a></li>
        
        <li><a href="/about/">关于我</a></li>
        
        <li><a href="/archives/">归档</a></li>
        
        <li><a href="/search/">搜索</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/kubernetes'>kubernetes</a></li>
                
                <li><a href='/tags/apiserver'>apiserver</a></li>
                
                <li><a href='/tags/etcd'>etcd</a></li>
                
                <li><a href='/tags/controller-manager'>controller-manager</a></li>
                
                <li><a href='/tags/scheduler'>scheduler</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= ""
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://zhangsiming-blyq.github.io/">百里英骐 By BaileysRock</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangsiming-blyq.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangsiming-blyq.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/monitor-control-plane/" title="prometheus 监测 kubernetes 控制平面">prometheus 监测 kubernetes 控制平面</a>
    </li>
    
    <li>
        <a href="https://zhangsiming-blyq.github.io/post/containerd/" title="浅谈 containerd">浅谈 containerd</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangsiming-blyq.github.io/tags/BaileysRock/">BaileysRock</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/about/">about</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/apiserver/">apiserver</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/containerd/">containerd</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/controller-manager/">controller-manager</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/etcd/">etcd</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/kubernetes/">kubernetes</a>
    
    <a href="https://zhangsiming-blyq.github.io/tags/scheduler/">scheduler</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
        </ul>
    </section>
</div>

            </div>
        </div>
    </div>
</body>

</html>